
{% extends 'base.html' %}
{% load role_tags %}
{% load project_extras %}
{% load humanize %}
{% load tz %}

{% block extra_css %}
<style>
    .upload-zone {
        border: 2px dashed #cbd5e1;
        border-radius: 8px;
        padding: 2rem;
        text-align: center;
        transition: all 0.3s;
        cursor: pointer;
    }

    .upload-zone:hover,
    .upload-zone.drag-over {
        border-color: #3b82f6;
        background: #eff6ff;
    }

    /* Notification Styles */
    .notification {
        position: fixed !important;
        top: 80px !important;
        right: 20px !important;
        max-width: 400px;
        padding: 1rem 1.5rem;
        border-radius: 8px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        display: flex;
        align-items: start;
        gap: 12px;
        z-index: 999999 !important;
        animation: slideIn 0.3s ease-out;
        opacity: 0;
        transform: translateX(100%);
        pointer-events: auto !important;
    }

    .notification.show {
        opacity: 1;
        transform: translateX(0);
    }

    .notification.hide {
        animation: slideOut 0.3s ease-out forwards;
    }

    .notification-success {
        background: #10b981;
        color: white;
    }

    .notification-error {
        background: #ef4444;
        color: white;
    }

    .notification-icon {
        flex-shrink: 0;
        width: 24px;
        height: 24px;
    }

    .notification-content {
        flex: 1;
    }

    .notification-title {
        font-weight: 600;
        margin-bottom: 4px;
    }

    .notification-message {
        font-size: 0.875rem;
        opacity: 0.9;
    }

    .notification-close {
        flex-shrink: 0;
        cursor: pointer;
        opacity: 0.8;
        transition: opacity 0.2s;
    }

    .notification-close:hover {
        opacity: 1;
    }

    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateX(100%);
        }
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }

    @keyframes slideOut {
        from {
            opacity: 1;
            transform: translateX(0);
        }
        to {
            opacity: 0;
            transform: translateX(100%);
        }
    }

    /* BOQ Summary Cards - Prevent text overlapping */
    .boq-summary-card {
        min-height: 100px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        word-wrap: break-word;
        overflow-wrap: break-word;
        padding: 1rem;
    }

    .boq-summary-value {
        line-height: 1.1;
        word-break: break-word;
        overflow-wrap: break-word;
        hyphens: auto;
    }

    /* Specific styling for total cost to prevent overflow */
    .boq-summary-card .boq-summary-value {
        font-size: 1.125rem; /* text-lg - better readability */
        max-width: 100%;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    /* Responsive font sizes for large numbers */
    @media (min-width: 1024px) {
        .boq-summary-card .boq-summary-value {
            font-size: 1.25rem; /* text-xl on large screens */
        }
    }

    @media (max-width: 1024px) {
        .boq-summary-card .boq-summary-value {
            font-size: 1rem; /* text-base on medium screens */
        }
    }

    @media (max-width: 768px) {
        .boq-summary-card .boq-summary-value {
            font-size: 0.875rem; /* text-sm on small screens */
        }
    }

    /* Extra small font for very long numbers */
    .boq-summary-card .boq-summary-value.long-number {
        font-size: 0.875rem; /* text-sm */
        line-height: 1.1;
    }

    @media (min-width: 1024px) {
        .boq-summary-card .boq-summary-value.long-number {
            font-size: 1rem; /* text-base on large screens */
        }
    }

    /* Specific styling for total cost card - balanced approach */
    #totalCostDisplay {
        font-size: 1rem !important; /* text-base */
        line-height: 1.2 !important;
        word-break: break-word !important;
        overflow-wrap: break-word !important;
        max-width: 100% !important;
        white-space: normal !important;
    }

    @media (min-width: 1024px) {
        #totalCostDisplay {
            font-size: 1.125rem !important; /* text-lg on large screens */
        }
    }

    @media (max-width: 768px) {
        #totalCostDisplay {
            font-size: 0.875rem !important; /* text-sm on small screens */
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50">
    <!-- Header Section -->
    <div class="bg-white border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center py-6 space-y-4 sm:space-y-0">
                <!-- Title & Status -->
                <div class="flex-1 min-w-0">
                    <div class="flex items-center space-x-3">
                        <h1 class="text-2xl font-bold text-gray-900 truncate">
                            {{ project.project_name }}
                        </h1>
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium
                            {% if project.status == 'CP' %} bg-green-100 text-green-800
                            {% elif project.status == 'OG' %} bg-blue-100 text-blue-800
                            {% elif project.status == 'PL' %} bg-gray-100 text-gray-800
                            {% else %} bg-red-100 text-red-800 {% endif %}">
                            {{ project.get_status_display }}
                        </span>
                    </div>
                    <p class="text-gray-600 text-sm mt-1">{{ project.project_id }}</p>
                </div>

                <!-- Action Buttons -->
                <div class="flex flex-wrap gap-3">
                    <!-- Back Button -->
                    {% if role == "PM" %}
                        <a href="{% url 'project_list'  %}"
                           class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 transition-colors">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
                            </svg>
                            Back
                        </a>
                    {% else %}
                        {% if project_source == 'client' %}
                            <a href="{% url 'manage_client:client_management' %}"
                               class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 transition-colors">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
                                </svg>
                                Back to Clients
                            </a>
                        {% elif project_source == 'progress' %}
        <a href="{% url 'progress_monitoring'  %}"
           class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 transition-colors">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
            </svg>
            Back to Progress Monitoring
        </a>
    {% else %}
                            {% if project.project_source == 'GC' %}
                                <a href="{% url 'project_list_general_contractor'  %}"
                                   class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 transition-colors">
                                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
                                    </svg>
                                    Back to Projects
                                </a>
                            {% else %}
                                <a href="{% url 'project_list_direct_client'  %}"
                                   class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 transition-colors">
                                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
                                    </svg>
                                    Back to Projects
                                </a>
                            {% endif %}
                        {% endif %}
                    {% endif %}

                    {% if user.is_superuser or user|has_role:"OM" or user|has_role:"EG" %}
                       <!-- Project Management Actions Dropdown -->
<div class="relative inline-block text-left">
    <button type="button" onclick="toggleProjectActions()" 
        class="inline-flex justify-center items-center w-full px-4 py-2 bg-gray-800 text-sm font-medium text-white rounded-lg hover:bg-gray-900 transition-colors">
        <svg class="w-5 h-5 mr-2 text-gray-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12h18M3 6h18M3 18h18"/>
        </svg>
        Project Management
        <svg class="w-4 h-4 ml-2 transition-transform duration-200" id="projectActionsChevron" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
        </svg>
    </button>

    <div id="projectActionsMenu"
        class="absolute right-0 mt-2 w-56 bg-white rounded-lg shadow-lg ring-1 ring-black ring-opacity-5 hidden z-50">
        <div class="py-2">

            <!-- Schedule -->
            {% if approved_schedule %}
                <a href="{% url 'schedule_detail' approved_schedule.id %}"
                   class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-green-50 transition">
                    <svg class="w-4 h-4 mr-2 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                    </svg>
                    Schedule
                </a>
            {% elif pending_schedule %}
                <a href="{% url 'schedule_detail' pending_schedule.id %}"
                   class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-green-50 transition">
                    <svg class="w-4 h-4 mr-2 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                    </svg>
                    Schedule
                </a>
            {% elif draft_schedule %}
                <a href="{% url 'schedule_detail' draft_schedule.id %}"
                   class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-green-50 transition">
                    <svg class="w-4 h-4 mr-2 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                    </svg>
                    Schedule
                </a>
            {% else %}
                <a href="{% url 'task_list' project.id %}?return_url={{ request.get_full_path|urlencode }}"
                   class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-green-50 transition">
                    <svg class="w-4 h-4 mr-2 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                    </svg>
                    Schedule
                </a>
            {% endif %}

            <!-- Gantt Chart -->
            <a href="{% url 'task_gantt_view'  project.id %}"
               class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-cyan-50 transition">
                <svg class="w-4 h-4 mr-2 text-cyan-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                </svg>
                Gantt Chart
            </a>

            <!-- 3-Week Lookahead -->
            <a href="{% url 'three_week_lookahead'  project.id %}"
               class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-amber-50 transition">
                <svg class="w-4 h-4 mr-2 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                </svg>
                3-Week Lookahead
            </a>

            <!-- Cost Tracking -->
            {% if project.approved_budget %}
            <a href="{% url 'project_detail_cost_dashboard' project.id %}"
               class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-purple-50 transition">
                <svg class="w-4 h-4 mr-2 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                Cost Tracking
            </a>
            {% endif %}
        </div>
    </div>
</div>

<script>
function toggleProjectActions() {
    const menu = document.getElementById('projectActionsMenu');
    const chevron = document.getElementById('projectActionsChevron');
    menu.classList.toggle('hidden');
    chevron.classList.toggle('rotate-180');
}

// Close dropdown when clicking outside
window.addEventListener('click', function(e) {
    const menu = document.getElementById('projectActionsMenu');
    const button = e.target.closest('button[onclick="toggleProjectActions()"]');
    if (!button && !e.target.closest('#projectActionsMenu')) {
        menu.classList.add('hidden');
        document.getElementById('projectActionsChevron').classList.remove('rotate-180');
    }
});
</script>


                        <!-- Edit Project Button -->
                        <!-- <a href="{% url 'project_edit'  project.id %}"
                           class="inline-flex items-center px-4 py-2 border border-transparent rounded-lg text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 transition-colors">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                            </svg>
                            Edit Project
                        </a> -->
                    {% endif %}
                </div>
            </div>
        </div>
    </div>


    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Main Details -->
            <div class="lg:col-span-2 space-y-8">
                <!-- Project Overview Card -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <h2 class="text-lg font-semibold text-gray-900">Project Overview</h2>
                    </div>
                    <div class="p-6">
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                            <div>
                                <dt class="text-xs font-medium text-gray-500 uppercase tracking-wide">Project Type</dt>
                                <dd class="text-sm font-medium text-gray-900">{{ project.project_type|display_type }}</dd>
                            </div>
                            <div>
                                <dt class="text-xs font-medium text-gray-500 uppercase tracking-wide">Category</dt>
                                <dd class="text-sm font-medium text-gray-900">{{ project.project_category|display_category }}</dd>
                            </div>
                            <div>
                                <dt class="text-xs font-medium text-gray-500 uppercase tracking-wide">Source</dt>
                                <dd class="text-sm font-medium text-gray-900">{{ project.project_source|display_source }}</dd>
                            </div>
                            <div>
                                <dt class="text-xs font-medium text-gray-500 uppercase tracking-wide">Project Manager</dt>
                                <dd class="text-sm font-medium text-gray-900">
                                    {% if project.project_manager %}
                                        {{ project.project_manager.full_name }}
                                    {% else %}
                                        <span class="text-gray-400">Not assigned</span>
                                    {% endif %}
                                </dd>
                            </div>
                            {% comment %}
                            <div>
                                <dt class="text-xs font-medium text-gray-500 uppercase tracking-wide">Site Engineer</dt>
                                <dd class="text-sm font-medium text-gray-900">{{ project.site_engineer|default:"Not assigned" }}</dd>
                            </div>
                            {% endcomment %}
                            <div>
                                <dt class="text-xs font-medium text-gray-500 uppercase tracking-wide">Location</dt>
                                <dd class="text-sm font-medium text-gray-900">{{ project.location|default:"Not specified" }}</dd>
                            </div>
                        </div>
                    </div>
                </div>

                {% comment %}
                <!-- Employee Assignments Card -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <h2 class="text-lg font-semibold text-gray-900">Employee Assignments</h2>
                    </div>
                    <div class="p-6">
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                            <!-- Project In Charge -->
                            <div class="flex items-center space-x-3">
                                <div>
                                    <dt class="text-xs font-medium text-gray-500 uppercase tracking-wide">Project In Charge</dt>
                                    <dd class="text-sm font-medium text-gray-900">
                                        {% if project.project_in_charge %}
                                            {{ project.project_in_charge.full_name }}
                                        {% else %}
                                            <span class="text-gray-400">Not assigned</span>
                                        {% endif %}
                                    </dd>
                                </div>
                            </div>

                            <!-- Safety Officer -->
                            <div class="flex items-center space-x-3">
                                <div>
                                    <dt class="text-xs font-medium text-gray-500 uppercase tracking-wide">Safety Officer</dt>
                                    <dd class="text-sm font-medium text-gray-900">
                                        {% if project.safety_officer %}
                                            {{ project.safety_officer.full_name }}
                                        {% else %}
                                            <span class="text-gray-400">Not assigned</span>
                                        {% endif %}
                                    </dd>
                                </div>
                            </div>

                            <!-- Quality Assurance Officer -->
                            <div class="flex items-center space-x-3">
                                <div>
                                    <dt class="text-xs font-medium text-gray-500 uppercase tracking-wide">Quality Assurance</dt>
                                    <dd class="text-sm font-medium text-gray-900">
                                        {% if project.quality_assurance_officer %}
                                            {{ project.quality_assurance_officer.full_name }}
                                        {% else %}
                                            <span class="text-gray-400">Not assigned</span>
                                        {% endif %}
                                    </dd>
                                </div>
                            </div>

                            <!-- Quality Officer -->
                            <div class="flex items-center space-x-3">
                                <div>
                                    <dt class="text-xs font-medium text-gray-500 uppercase tracking-wide">Quality Officer</dt>
                                    <dd class="text-sm font-medium text-gray-900">
                                        {% if project.quality_officer %}
                                            {{ project.quality_officer.full_name }}
                                        {% else %}
                                            <span class="text-gray-400">Not assigned</span>
                                        {% endif %}
                                    </dd>
                                </div>
                            </div>

                            <!-- Foreman -->
                            <div class="flex items-center space-x-3">
                                <div>
                                    <dt class="text-xs font-medium text-gray-500 uppercase tracking-wide">Foreman</dt>
                                    <dd class="text-sm font-medium text-gray-900">
                                        {% if project.foreman %}
                                            {{ project.foreman.full_name }}
                                        {% else %}
                                            <span class="text-gray-400">Not assigned</span>
                                        {% endif %}
                                    </dd>
                                </div>
                            </div>

                            <!-- Number of Laborers -->
                            <div class="flex items-center space-x-3">
                                <div>
                                    <dt class="text-xs font-medium text-gray-500 uppercase tracking-wide">Laborers</dt>
                                    <dd class="text-sm font-medium text-gray-900">
                                        {{ project.number_of_laborers|default:0 }} workers
                                    </dd>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endcomment %}

                <!-- Schedule Management Card -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                    <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                        <h2 class="text-lg font-semibold text-gray-900">Schedule Management</h2>
                        {% if approved_schedule %}
                            <span class="px-3 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">
                                Approved
                            </span>
                        {% elif pending_schedule %}
                            <span class="px-3 py-1 text-xs font-semibold rounded-full bg-yellow-100 text-yellow-800">
                                Pending Approval
                            </span>
                        {% elif draft_schedule %}
                            <span class="px-3 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-800">
                                Draft
                            </span>
                        {% elif rejected_schedule %}
                            <span class="px-3 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-800">
                                Rejected
                            </span>
                        {% else %}
                            <span class="px-3 py-1 text-xs font-semibold rounded-full bg-gray-100 text-gray-600">
                                Not Started
                            </span>
                        {% endif %}
                    </div>
                    <div class="p-6">
                        {% if approved_schedule %}
                            <!-- Schedule Approved -->
                            <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                                <div class="flex items-start">
                                    <svg class="h-5 w-5 text-green-600 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                    <div class="ml-3 flex-1">
                                        <h3 class="text-sm font-medium text-green-800">Schedule Approved</h3>
                                        <div class="mt-2 text-sm text-green-700">
                                            <p><strong>{{approved_schedule.task_count}}</strong> tasks created from schedule</p>
                                            <p class="text-xs mt-1">Approved by {{approved_schedule.reviewed_by.full_name}} on {{approved_schedule.reviewed_at|date:"M d, Y"}}</p>
                                        </div>
                                        <div class="mt-4 flex gap-3">
                                            <a href="{% url 'task_list' project.id %}" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700">
                                                View Tasks
                                            </a>
                                            {% if role == 'PM' or role == 'EG' or role == 'OM' %}
                                                <a href="{% url 'schedule_detail' approved_schedule.id %}" class="inline-flex items-center px-4 py-2 border border-green-300 text-sm font-medium rounded-md text-green-700 bg-white hover:bg-green-50">
                                                    View Schedule
                                                </a>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>

                        {% elif pending_schedule %}
                            <!-- Schedule Pending -->
                            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                                <div class="flex items-start">
                                    <svg class="h-5 w-5 text-yellow-600 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                    <div class="ml-3 flex-1">
                                        <h3 class="text-sm font-medium text-yellow-800">Schedule Pending Approval</h3>
                                        <div class="mt-2 text-sm text-yellow-700">
                                            <p>Schedule v{{pending_schedule.version}} awaiting OM/EG review</p>
                                            <p class="text-xs mt-1">Submitted on {{pending_schedule.submitted_at|date:"M d, Y h:i A"}}</p>
                                        </div>
                                        <div class="mt-4 flex gap-3">
                                            {% if role == 'PM' or role == 'EG' or role == 'OM' %}
                                                <a href="{% url 'schedule_detail' pending_schedule.id %}" class="inline-flex items-center px-4 py-2 border border-yellow-300 text-sm font-medium rounded-md text-yellow-700 bg-white hover:bg-yellow-50">
                                                    View Schedule
                                                </a>
                                            {% endif %}
                                            {% if role == 'OM' or role == 'EG' %}
                                                <a href="{% url 'review_project_schedule' pending_schedule.id %}" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700">
                                                    Review Schedule
                                                </a>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>

                        {% elif draft_schedule %}
                            <!-- Draft Schedule -->
                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                <div class="flex items-start">
                                    <svg class="h-5 w-5 text-blue-600 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                    </svg>
                                    <div class="ml-3 flex-1">
                                        <h3 class="text-sm font-medium text-blue-800">Draft Schedule Available</h3>
                                        <div class="mt-2 text-sm text-blue-700">
                                            <p>Schedule v{{draft_schedule.version}} uploaded but not submitted</p>
                                            {% if draft_schedule.validation_errors.errors %}
                                                <p class="text-xs mt-1 text-red-600">âš  Has validation errors - please fix before submitting</p>
                                            {% endif %}
                                        </div>
                                        <div class="mt-4">
                                            <a href="{% url 'schedule_detail' draft_schedule.id %}" class="inline-flex items-center px-4 py-2 border border-blue-300 text-sm font-medium rounded-md text-blue-700 bg-white hover:bg-blue-50">
                                                View Draft
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>

                        {% elif rejected_schedule %}
                            <!-- Rejected Schedule -->
                            <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                                <div class="flex items-start">
                                    <svg class="h-5 w-5 text-red-600 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                    <div class="ml-3 flex-1">
                                        <h3 class="text-sm font-medium text-red-800">Schedule Rejected</h3>
                                        <div class="mt-2 text-sm text-red-700">
                                            <p>Schedule v{{rejected_schedule.version}} was rejected</p>
                                            <p class="text-xs mt-1">Rejected by {{rejected_schedule.reviewed_by.full_name}} on {{rejected_schedule.reviewed_at|date:"M d, Y h:i A"}}</p>
                                            {% if rejected_schedule.rejection_reason %}
                                                <div class="mt-3 bg-white border border-red-200 rounded p-3">
                                                    <p class="text-xs font-semibold text-red-900 mb-1">Rejection Reason:</p>
                                                    <p class="text-xs text-red-800">{{rejected_schedule.rejection_reason}}</p>
                                                </div>
                                            {% endif %}
                                        </div>
                                        <div class="mt-4 flex gap-3">
                                            <a href="{% url 'schedule_detail' rejected_schedule.id %}" class="inline-flex items-center px-4 py-2 border border-red-300 text-sm font-medium rounded-md text-red-700 bg-white hover:bg-red-50">
                                                View Rejected Schedule
                                            </a>
                                            {% if role == 'PM' %}
                                                <button onclick="openUploadModal()" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700">
                                                    <svg class="h-4 w-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                                                    </svg>
                                                    Upload New Version
                                                </button>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>

                        {% else %}
                            <!-- No Schedule -->
                            <div class="text-center py-6">
                                <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                </svg>
                                <h3 class="mt-2 text-sm font-medium text-gray-900">No Schedule Yet</h3>
                                <p class="mt-1 text-sm text-gray-500">Get started by generating a schedule template</p>
                                <div class="mt-6 flex justify-center gap-3">
                                    <a href="{% url 'generate_schedule_template' project.id %}" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700">
                                        <svg class="h-4 w-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                        </svg>
                                        Generate Template
                                    </a>
                                    {% if role == 'PM' %}
                                        <button onclick="openUploadModal()" class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                                            <svg class="h-4 w-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                                            </svg>
                                            Upload Schedule
                                        </button>
                                    {% endif %}
                                </div>
                            </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Weekly Progress Tracking Card -->
                {% if role == "PM" or role == "OM" or role == "EG" %}
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <h2 class="text-lg font-semibold text-gray-900">Weekly Progress Tracking</h2>
                    </div>
                    <div class="p-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <!-- Submit Progress (PM Only) -->
                            {% if role == "PM" %}
                                <a href="{% url 'submit_weekly_progress' project.id %}"
                                   class="flex items-center gap-3 px-4 py-3 bg-emerald-50 border border-emerald-200 rounded-lg hover:bg-emerald-100 transition-colors group">
                                    <div class="w-10 h-10 bg-emerald-600 rounded-lg flex items-center justify-center flex-shrink-0 group-hover:bg-emerald-700 transition-colors">
                                        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                                        </svg>
                                    </div>
                                    <div class="flex-1">
                                        <p class="text-sm font-semibold text-emerald-900">Submit Progress</p>
                                        <p class="text-xs text-emerald-700">Upload weekly report</p>
                                    </div>
                                    <svg class="w-5 h-5 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                    </svg>
                                </a>

                                
                            {% endif %}

                            <!-- View Reports (All Roles) -->
                            <a href="{% url 'list_weekly_reports' project.id %}"
                               class="flex items-center gap-3 px-4 py-3 bg-purple-50 border border-purple-200 rounded-lg hover:bg-purple-100 transition-colors group">
                                <div class="w-10 h-10 bg-purple-600 rounded-lg flex items-center justify-center flex-shrink-0 group-hover:bg-purple-700 transition-colors">
                                    <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                                    </svg>
                                </div>
                                <div class="flex-1">
                                    <p class="text-sm font-semibold text-purple-900">View Reports</p>
                                    <p class="text-xs text-purple-700">All progress reports</p>
                                </div>
                                <svg class="w-5 h-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                </svg>
                            </a>

                            <!-- Review Reports (OM/EG Only) -->
                            {% if role == "OM" or role == "EG" %}
                                <a href="{% url 'review_weekly_reports' %}"
                                   class="flex items-center gap-3 px-4 py-3 bg-orange-50 border border-orange-200 rounded-lg hover:bg-orange-100 transition-colors group">
                                    <div class="w-10 h-10 bg-orange-600 rounded-lg flex items-center justify-center flex-shrink-0 group-hover:bg-orange-700 transition-colors">
                                        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                        </svg>
                                    </div>
                                    <div class="flex-1">
                                        <p class="text-sm font-semibold text-orange-900">Review Reports</p>
                                        <p class="text-xs text-orange-700">Approve pending reports</p>
                                    </div>
                                    <svg class="w-5 h-5 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                    </svg>
                                </a>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Subcontractors Card -->
                {% if role == "OM" or role == "EG" %}
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                    <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
                        <div>
                            <h2 class="text-lg font-semibold text-gray-900">Subcontractors</h2>
                            <p class="text-xs text-gray-500 mt-1" id="subcontractorCount">Loading...</p>
                        </div>
                        <button onclick="openAddSubcontractorModal()"
                                class="inline-flex items-center px-3 py-1.5 text-xs font-medium text-white bg-blue-600 hover:bg-blue-700 border border-blue-300 rounded-lg transition-colors">
                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                            </svg>
                            Add Subcontractor
                        </button>
                    </div>

                    <div class="p-6">
                        <div id="subcontractorsList" class="space-y-3">
                            <!-- Subcontractors will load here -->
                            <div class="text-center py-6 text-gray-500">
                                <svg class="w-10 h-10 text-gray-400 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
                                </svg>
                                <p class="text-sm">Loading subcontractors...</p>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Timeline Card -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <h2 class="text-lg font-semibold text-gray-900">Timeline</h2>
                    </div>
                    <div class="p-6">
                        <div class="flex items-center justify-between">
                            <div class="flex-1">
                                <div class="flex items-center space-x-4">
                                    <div class="text-center">
                                        <div class="text-xs font-medium text-gray-500 mb-1">Start Date</div>
                                        <div class="text-sm font-semibold text-gray-900">
                                            {{ project.start_date|format_date|default:"Not set" }}
                                        </div>
                                    </div>
                                   {% include "components/progress_bar.html" with value=project.timeline_progress %}

                                    <div class="text-center">
                                        <div class="text-xs font-medium text-gray-500 mb-1">Target Completion</div>
                                        <div class="text-sm font-semibold text-gray-900">
                                            {{ project.target_completion_date|format_date|default:"Not set" }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- BOQ (Bill of Quantities) Card -->
                {% comment %}Always show BOQ section to demonstrate functionality{% endcomment %}
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                    <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
                        <div>
                            <h2 class="text-lg font-semibold text-gray-900 flex items-center">
                                <svg class="w-5 h-5 mr-2 text-purple-500" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M4 4a2 2 0 00-2 2v8a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2H4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd"></path>
                                </svg>
                                Bill of Quantities (BOQ)
                            </h2>
                            <p class="text-xs text-gray-500 mt-1">
                                {% if project.boq_items %}
                                    {{ project.boq_items|length }} item{{ project.boq_items|length|pluralize }} â€¢ 
                                    Total: â‚±{{ project.extracted_total_cost|floatformat:2|intcomma|default:"0.00" }}
                                {% elif project.boq_file_processed %}
                                    BOQ file processed but no items extracted
                                {% else %}
                                    No BOQ data available - Upload BOQ files during project creation
                                {% endif %}
                            </p>
                        </div>
                        <div class="flex items-center space-x-2">
                            {% if project.boq_items %}
                            <button onclick="exportBOQToExcel()" 
                                    class="inline-flex items-center px-3 py-1.5 text-xs font-medium text-green-600 hover:text-green-700 border border-green-300 rounded-lg hover:bg-green-50 transition-colors">
                                <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                                </svg>
                                Export Excel
                            </button>
                            {% endif %}
                            <button onclick="toggleBOQPreview()" 
                                    class="inline-flex items-center px-3 py-1.5 text-xs font-medium text-blue-600 hover:text-blue-700 border border-blue-300 rounded-lg hover:bg-blue-50 transition-colors">
                                <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M10 12a2 2 0 100-4 2 2 0 000 4z"></path>
                                    <path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd"></path>
                                </svg>
                                Preview
                            </button>
                        </div>
                    </div>
                    <div class="p-6">
                        {% if project.boq_items %}
                            <!-- BOQ Summary -->
                            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4 mb-6">
                                <div class="bg-purple-50 rounded-lg p-4 border border-purple-200 boq-summary-card">
                                    <div class="text-xs font-medium text-purple-600 uppercase tracking-wide mb-2">Total Items</div>
                                    <div class="text-xl lg:text-2xl font-bold text-purple-900 boq-summary-value">{{ project.boq_items|length }}</div>
                                </div>
                                <div class="bg-green-50 rounded-lg p-4 border border-green-200 boq-summary-card" style="min-width: 0; flex: 1;">
                                    <div class="text-xs font-medium text-green-600 uppercase tracking-wide mb-2">Total Cost</div>
                                    <div class="text-base lg:text-lg font-bold text-green-900 boq-summary-value" id="totalCostDisplay">â‚±{{ project.extracted_total_cost|floatformat:2|intcomma|default:"0.00" }}</div>
                                </div>
                                <div class="bg-blue-50 rounded-lg p-4 border border-blue-200 boq-summary-card">
                                    <div class="text-xs font-medium text-blue-600 uppercase tracking-wide mb-2">Lot Size</div>
                                    <div class="text-lg lg:text-xl font-bold text-blue-900 boq-summary-value">{{ project.lot_size|floatformat:0|default:"0" }} mÂ²</div>
                                </div>
                                <div class="bg-orange-50 rounded-lg p-4 border border-orange-200 boq-summary-card">
                                    <div class="text-xs font-medium text-orange-600 uppercase tracking-wide mb-2">Floor Area</div>
                                    <div class="text-lg lg:text-xl font-bold text-orange-900 boq-summary-value" id="floorAreaDisplay">{{ project.floor_area|floatformat:0|default:"0" }} mÂ²</div>
                                </div>
                                <div class="bg-indigo-50 rounded-lg p-4 border border-indigo-200 boq-summary-card">
                                    <div class="text-xs font-medium text-indigo-600 uppercase tracking-wide mb-2">Cost per mÂ²</div>
                                    <div class="text-lg lg:text-xl font-bold text-indigo-900 boq-summary-value" id="costPerSqm">
                                        â‚±0.00
                                    </div>
                                </div>
                            </div>

                            <!-- Cost Breakdown -->
                            {% if project.extracted_cost_breakdown %}
                            <div class="mb-6">
                                <h3 class="text-sm font-semibold text-gray-900 mb-3">Cost Breakdown</h3>
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                                    {% for category, amount in project.extracted_cost_breakdown.items %}
                                    <div class="bg-gray-50 rounded-lg p-3 border border-gray-200">
                                        <div class="text-xs font-medium text-gray-600 uppercase tracking-wide">{{ category|title }}</div>
                                        <div class="text-lg font-semibold text-gray-900">â‚±{{ amount|floatformat:2|intcomma }}</div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endif %}

                            <!-- BOQ Items with Hierarchical Display -->
                            <div id="boqPreview" class="hidden">
                                <div class="flex justify-between items-center mb-3">
                                    <h3 class="text-sm font-semibold text-gray-900">BOQ Items</h3>
                                    <div class="flex items-center space-x-2">
                                        <span class="text-xs text-gray-500">Items per page:</span>
                                        <select id="itemsPerPage" class="text-xs border border-gray-300 rounded px-2 py-1">
                                            <option value="5">5</option>
                                            <option value="10" selected>10</option>
                                            <option value="20">20</option>
                                            <option value="50">50</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div id="boqHierarchicalDisplay" class="space-y-6">
                                    <!-- Hierarchical BOQ items will be populated by JavaScript -->
                                </div>
                                
                                <!-- Pagination Controls -->
                                <div class="mt-4 flex items-center justify-between">
                                    <div class="text-sm text-gray-700">
                                        Showing <span id="showingStart">1</span> to <span id="showingEnd">10</span> of 
                                        <span id="totalItems">{{ project.boq_items|length }}</span> items
                                    </div>
                                    
                                    <div class="flex items-center space-x-2">
                                        <button id="prevPage" class="px-3 py-1 text-xs border border-gray-300 rounded hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                                            Previous
                                        </button>
                                        
                                        <div id="pageNumbers" class="flex space-x-1">
                                            <!-- Page numbers will be populated by JavaScript -->
                                        </div>
                                        
                                        <button id="nextPage" class="px-3 py-1 text-xs border border-gray-300 rounded hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                                            Next
                                        </button>
                                    </div>
                                </div>
                            </div>
                        {% else %}
                            <div class="text-center py-8">
                                <svg class="w-12 h-12 text-gray-400 mx-auto mb-4" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M4 4a2 2 0 00-2 2v8a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2H4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd"></path>
                                </svg>
                                <p class="text-gray-500 text-sm mb-3">No BOQ data available</p>
                                <p class="text-gray-400 text-xs">
                                    {% if project.boq_file_processed %}
                                        BOQ file was processed but no items were extracted
                                    {% else %}
                                        Upload BOQ files during project creation to see detailed cost breakdown
                                    {% endif %}
                                </p>
                                <div class="mt-4">
                                    <a href="{% url 'project_list' %}" class="inline-flex items-center px-4 py-2 text-sm font-medium text-blue-600 hover:text-blue-700 border border-blue-300 rounded-lg hover:bg-blue-50 transition-colors">
                                        <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M12 6v6m0 0v6m0-6h6m-6 0H6" clip-rule="evenodd"></path>
                                        </svg>
                                        Go to Projects
                                    </a>
                                </div>
                            </div>
                        {% endif %}
                    </div>
                </div>

                <!-- BOQ Data Script -->
                <script type="application/json" id="boq-data">
                {
                    "boq_items": {{ project.boq_items|default:"[]"|safe }},
                    "division_subtotals": {{ project.boq_division_subtotals|default:"{}"|safe }},
                    "boq_project_info": {{ project.boq_project_info|default:"{}"|safe }},
                    "floor_area": {{ project.floor_area|default:0|floatformat:0 }},
                    "lot_size": {{ project.lot_size|default:0|floatformat:0 }}
                }
                </script>

                <!-- Description Card -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <h2 class="text-lg font-semibold text-gray-900">Description</h2>
                    </div>
                    <div class="p-6">
                        <p class="text-gray-700 leading-relaxed">
                            {{ project.description|default:"No description provided." }}
                        </p>
                    </div>
                </div>

            </div>

            <!-- Sidebar -->
            <div class="space-y-8">
                <!-- Client Information Card -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <h2 class="text-lg font-semibold text-gray-900">Client Information</h2>
                    </div>
                    <div class="p-6">
                        {% if project.client %}
                            <div class="space-y-4">
                                <div>
                                    <dt class="text-xs font-medium text-gray-500 uppercase tracking-wide mb-1">Company</dt>
                                    <dd class="text-sm font-medium text-gray-900">{{ project.client.company_name }}</dd>
                                </div>
                                <div>
                                    <dt class="text-xs font-medium text-gray-500 uppercase tracking-wide mb-1">Contact Person</dt>
                                    <dd class="text-sm text-gray-900">{{ project.client.contact_name }}</dd>
                                </div>
                                {% if project.client.email %}
                                    <div>
                                        <dt class="text-xs font-medium text-gray-500 uppercase tracking-wide mb-1">Email</dt>
                                        <dd class="text-sm text-gray-900">
                                            <a href="mailto:{{ project.client.email }}" class="text-blue-600 hover:text-blue-700">
                                                {{ project.client.email }}
                                            </a>
                                        </dd>
                                    </div>
                                {% endif %}
                                {% if project.client.phone %}
                                    <div>
                                        <dt class="text-xs font-medium text-gray-500 uppercase tracking-wide mb-1">Phone</dt>
                                        <dd class="text-sm text-gray-900">
                                            <a href="tel:{{ project.client.phone }}" class="text-blue-600 hover:text-blue-700">
                                                {{ project.client.phone }}
                                            </a>
                                        </dd>
                                    </div>
                                {% endif %}
                                {% if project.client.address %}
                                    <div>
                                        <dt class="text-xs font-medium text-gray-500 uppercase tracking-wide mb-1">Address</dt>
                                        <dd class="text-sm text-gray-900">
                                            {{ project.client.address }}{% if project.client.city %}, {{ project.client.city }}{% endif %}{% if project.client.state %}, {{ project.client.state }}{% endif %} {{ project.client.zip_code }}
                                        </dd>
                                    </div>
                                {% endif %}
                            </div>
                        {% else %}
                            <div class="text-center py-6">
                                <svg class="w-12 h-12 text-gray-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                                </svg>
                                <p class="text-gray-500 text-sm">No client assigned</p>
                            </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Financial Information (for authorized roles) -->
                {% if role == "OM" or role == "EG" %}
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                        <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
                            <h2 class="text-lg font-semibold text-gray-900">Financial Overview</h2>
                            <div class="flex items-center gap-3">
                                {% if not project.approved_budget %}
                                    <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-yellow-100 text-yellow-800">
                                        Pending Approval
                                    </span>
                                {% else %}
                                    <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-green-100 text-green-800">
                                        Approved
                                    </span>
                                {% endif %}
                                <!-- Cost Tracking Button -->
                                <a href="{% url 'project_detail_cost_dashboard' project_id=project.id %}"
                                   class="inline-flex items-center px-2 py-1 text-xs font-medium text-purple-600 hover:text-purple-700 border border-purple-300 rounded hover:bg-purple-50 transition-colors whitespace-nowrap">
                                    <svg class="w-3 h-3 mr-1 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                              d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                    </svg>
                                    <span class="truncate">Cost Tracking</span>
                                </a>
                            </div>
                        </div>
                        <div class="p-6 space-y-4">
                            <div class="flex justify-between items-center">
                                <span class="text-sm font-medium text-gray-500">Approved Budget</span>
                                    <span class="text-sm font-semibold text-green-600">â‚±{{ project.approved_budget|floatformat:2|intcomma  }}</span>
                            </div>
                            {% if project.approved_budget %}
                                {% if project.allocated_funds %}
                                    <div class="flex justify-between items-center">
                                        <span class="text-sm font-medium text-gray-500">Allocated Funds</span>
                                        <span class="text-sm font-semibold text-gray-900">â‚±{{ project.allocated_funds|floatformat:2|intcomma  }}</span>
                                    </div>
                                {% endif %}
                                {% if project.expense %}
                                    <div class="flex justify-between items-center">
                                        <span class="text-sm font-medium text-gray-500">Total Expenses</span>
                                        <span class="text-sm font-semibold text-red-600">â‚±{{ project.expense|floatformat:2|intcomma  }}</span>
                                    </div>
                                {% endif %}
                                
                                <div class="flex justify-between items-center border-t pt-4">
                                    <span class="text-sm font-medium text-gray-500">Payment Terms</span>
                                    <span class="text-sm text-gray-900">{{ project.payment_terms|default:"Not specified" }}</span>
                                </div>

                                <!-- Downpayment Status -->
                                <div class="border-t pt-4">
                                    <div class="flex justify-between items-center mb-2">
                                        <span class="text-sm font-medium text-gray-500">Downpayment Status</span>
                                        <div class="flex items-center gap-2">
                                            {% if project.downpayment_paid %}
                                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                                    <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                                                    </svg>
                                                    Paid
                                                </span>
                                            {% else %}
                                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                                                    <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                                                    </svg>
                                                    Not Paid
                                                </span>
                                                <button onclick="openDownpaymentUpdateModal()"
                                                        class="inline-flex items-center px-2 py-1 text-xs font-medium text-blue-600 hover:text-blue-700 border border-blue-300 rounded hover:bg-blue-50 transition-colors">
                                                    <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                                                    </svg>
                                                    Update
                                                </button>
                                            {% endif %}
                                        </div>
                                    </div>
                                    {% if project.downpayment_paid and project.downpayment_date %}
                                        <p class="text-xs text-gray-500 mt-1">
                                            Received: {{ project.downpayment_date|date:"M d, Y" }}
                                        </p>
                                    {% endif %}
                                    {% if project.downpayment_evidence %}
                                        <button type="button"
                                                onclick="openEvidencePreview('{{ project.downpayment_evidence.url }}', '{{ project.downpayment_evidence.name }}')"
                                                class="inline-flex items-center text-xs text-blue-600 hover:text-blue-700 mt-1">
                                            <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                                            </svg>
                                            View Evidence
                                        </button>
                                    {% endif %}
                                </div>
                            {% endif %}
                        </div>
                    </div>

                {% endif %}

                <!-- Documents -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                    <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
                        <div>
                            <h2 class="text-lg font-semibold text-gray-900">Documents</h2>
                            <p class="text-xs text-gray-500 mt-1">
                                {{ project.documents.count }} document{{ project.documents.count|pluralize }}
                            </p>
                        </div>
                        <button onclick="openUploadModal()" 
                                class="inline-flex items-center px-3 py-1.5 text-xs font-medium text-blue-600 hover:text-blue-700 border border-blue-300 rounded-lg hover:bg-blue-50 transition-colors">
                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                            </svg>
                            Upload
                        </button>
                    </div>

                    <div class="p-6">
                        <!-- Mandatory Documents Warning -->
                        {% if project.missing_mandatory_documents %}
                            <div class="mb-4 p-3 bg-yellow-50 border-l-4 border-yellow-400 rounded">
                                <div class="flex">
                                    <svg class="w-5 h-5 text-yellow-400 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                                    </svg>
                                    <div>
                                        <p class="text-sm font-medium text-yellow-800">Missing Mandatory Documents:</p>
                                        <ul class="text-xs text-yellow-700 mt-1 list-disc list-inside">
                                            {% for doc in project.missing_mandatory_documents %}
                                                <li>{{ doc }}</li>
                                            {% endfor %}
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        {% endif %}

                        <!-- Contract Documents -->
                        {% if project.contract_documents.exists %}
                            <div class="mb-4">
                                <h3 class="text-xs font-semibold text-gray-700 uppercase tracking-wide mb-2 flex items-center">
                                    <svg class="w-4 h-4 text-blue-500 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                    </svg>
                                    Contracts ({{ project.contract_documents.count }})
                                </h3>
                                <div class="space-y-2">
                                    {% for doc in project.contract_documents|slice:":3" %}
                                        <a href="/projects/api/documents/{{ doc.id }}/download/"
                                           class="flex items-center justify-between p-2 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors">
                                            <div class="flex items-center min-w-0">
                                                <div class="flex-shrink-0 w-8 h-8 bg-blue-100 rounded flex items-center justify-center">
                                                    <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                                    </svg>
                                                </div>
                                                <div class="ml-3 min-w-0">
                                                    <p class="text-xs font-medium text-gray-900 truncate">{{ doc.title }}</p>
                                                    <p class="text-xs text-gray-500">v{{ doc.version }}</p>
                                                </div>
                                            </div>
                                            <svg class="w-4 h-4 text-gray-400 flex-shrink-0 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                                            </svg>
                                        </a>
                                    {% endfor %}
                                </div>
                            </div>
                        {% endif %}

                        <!-- Permit Documents -->
                        {% if project.permit_documents.exists %}
                            <div class="mb-4">
                                <h3 class="text-xs font-semibold text-gray-700 uppercase tracking-wide mb-2 flex items-center">
                                    <svg class="w-4 h-4 text-green-500 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                    </svg>
                                    Permits & Licenses ({{ project.permit_documents.count }})
                                </h3>
                                <div class="space-y-2">
                                    {% for doc in project.permit_documents|slice:":3" %}
                                        <a href="/projects/api/documents/{{ doc.id }}/download/"
                                           class="flex items-center justify-between p-2 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors">
                                            <div class="flex items-center min-w-0">
                                                <div class="flex-shrink-0 w-8 h-8 bg-green-100 rounded flex items-center justify-center">
                                                    <svg class="w-4 h-4 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                                    </svg>
                                                </div>
                                                <div class="ml-3 min-w-0">
                                                    <p class="text-xs font-medium text-gray-900 truncate">{{ doc.title }}</p>
                                                    <p class="text-xs text-gray-500">v{{ doc.version }}</p>
                                                </div>
                                            </div>
                                            <svg class="w-4 h-4 text-gray-400 flex-shrink-0 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                                            </svg>
                                        </a>
                                    {% endfor %}
                                </div>
                            </div>
                        {% endif %}

                        <!-- View All Documents Link -->
                        {% if project.documents.count > 0 %}
                            <div class="mt-4 pt-4 border-t border-gray-200">
                                <a href="{% url 'document_library' %}?project={{ project.id }}"
                                   class="flex items-center justify-center text-sm font-medium text-blue-600 hover:text-blue-700">
                                    View All {{ project.documents.count }} Document{{ project.documents.count|pluralize }}
                                    <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                    </svg>
                                </a>
                            </div>
                        {% else %}
                            <div class="text-center py-6">
                                <svg class="w-12 h-12 text-gray-400 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                </svg>
                                <p class="text-gray-500 text-sm mb-3">No documents uploaded yet</p>
                                <button onclick="openUploadModal()" 
                                        class="inline-flex items-center px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition-colors">
                                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                                    </svg>
                                    Upload First Document
                                </button>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Upload Modal -->
<div id="uploadModal" class="fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50" style="display: none;">
    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
        <div class="p-6 border-b border-gray-200">
            <div class="flex justify-between items-center">
                <h2 class="text-2xl font-bold text-gray-900">Upload Document</h2>
                <button onclick="closeUploadModal()" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
        </div>

        <form id="uploadForm" class="p-6" onsubmit="handleUpload(event)">
            <!-- Upload Zone -->
            <div id="uploadZone" class="upload-zone mb-6" onclick="document.getElementById('fileInput').click()">
                <svg class="w-16 h-16 mx-auto text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                </svg>
                <p class="text-lg font-semibold text-gray-700 mb-1">Click to upload or drag and drop</p>
                <p class="text-sm text-gray-500">PDF, DOC, XLS, Images (Max 10MB)</p>
                <input type="file" id="fileInput" class="hidden" accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png" multiple onchange="handleFileSelect(event)">
            </div>

            <div id="selectedFiles" class="hidden mb-6">
                <div class="flex items-center justify-between mb-2">
                    <p class="text-sm font-semibold text-gray-700">
                        <span id="fileCount">0</span> file(s) selected
                    </p>
                    <button type="button" onclick="clearFiles()" class="text-red-600 hover:text-red-700 text-sm font-medium">
                        Clear All
                    </button>
                </div>
                <div id="fileList" class="space-y-2 max-h-40 overflow-y-auto">
                    <!-- Files will be listed here -->
                </div>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Document Title *</label>
                    <input
                        type="text"
                        id="docTitle"
                        required
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                        placeholder="e.g., Project Contract Agreement"
                    >
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                    <textarea
                        id="docDescription"
                        rows="3"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                        placeholder="Brief description of the document..."
                    ></textarea>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div class="col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Project *</label>
                        <select id="docProject" required class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all">
                            <option value="{{ project.id }}">{{ project.project_name }}</option>
                        </select>
                    </div>
                </div>

                <!-- Enhanced Document Type Selection -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-3">Document Type *</label>
                    <div class="grid grid-cols-2 sm:grid-cols-4 gap-3">
                        <!-- Contract -->
                        <div class="doc-type-option" data-type="CONTRACT" onclick="selectDocType('CONTRACT', this)">
                            <div class="flex flex-col items-center justify-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer transition-all hover:border-blue-400 hover:bg-blue-50">
                                <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center mb-2">
                                    <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                    </svg>
                                </div>
                                <span class="text-xs font-medium text-gray-700 text-center">Contract</span>
                            </div>
                        </div>

                        <!-- Permit -->
                        <div class="doc-type-option" data-type="PERMIT" onclick="selectDocType('PERMIT', this)">
                            <div class="flex flex-col items-center justify-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer transition-all hover:border-green-400 hover:bg-green-50">
                                <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center mb-2">
                                    <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
                                    </svg>
                                </div>
                                <span class="text-xs font-medium text-gray-700 text-center">Permit</span>
                            </div>
                        </div>

                        <!-- Report -->
                        <div class="doc-type-option" data-type="PROGRESS" onclick="selectDocType('PROGRESS', this)">
                            <div class="flex flex-col items-center justify-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer transition-all hover:border-purple-400 hover:bg-purple-50">
                                <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center mb-2">
                                    <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                    </svg>
                                </div>
                                <span class="text-xs font-medium text-gray-700 text-center">Report</span>
                            </div>
                        </div>

                        <!-- Invoice -->
                        <div class="doc-type-option" data-type="INVOICE" onclick="selectDocType('INVOICE', this)">
                            <div class="flex flex-col items-center justify-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer transition-all hover:border-orange-400 hover:bg-orange-50">
                                <div class="w-12 h-12 bg-orange-100 rounded-lg flex items-center justify-center mb-2">
                                    <svg class="w-6 h-6 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path>
                                    </svg>
                                </div>
                                <span class="text-xs font-medium text-gray-700 text-center">Invoice</span>
                            </div>
                        </div>

                        <!-- Blueprint -->
                        <div class="doc-type-option" data-type="TECHNICAL" onclick="selectDocType('TECHNICAL', this)">
                            <div class="flex flex-col items-center justify-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer transition-all hover:border-indigo-400 hover:bg-indigo-50">
                                <div class="w-12 h-12 bg-indigo-100 rounded-lg flex items-center justify-center mb-2">
                                    <svg class="w-6 h-6 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"></path>
                                    </svg>
                                </div>
                                <span class="text-xs font-medium text-gray-700 text-center">Blueprint</span>
                            </div>
                        </div>

                        <!-- Photo -->
                        <div class="doc-type-option" data-type="PHOTO" onclick="selectDocType('PHOTO', this)">
                            <div class="flex flex-col items-center justify-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer transition-all hover:border-cyan-400 hover:bg-cyan-50">
                                <div class="w-12 h-12 bg-cyan-100 rounded-lg flex items-center justify-center mb-2">
                                    <svg class="w-6 h-6 text-cyan-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                    </svg>
                                </div>
                                <span class="text-xs font-medium text-gray-700 text-center">Photo</span>
                            </div>
                        </div>

                        <!-- Costing -->
                        <div class="doc-type-option" data-type="COSTING" onclick="selectDocType('COSTING', this)">
                            <div class="flex flex-col items-center justify-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer transition-all hover:border-yellow-400 hover:bg-yellow-50">
                                <div class="w-12 h-12 bg-yellow-100 rounded-lg flex items-center justify-center mb-2">
                                    <svg class="w-6 h-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                </div>
                                <span class="text-xs font-medium text-gray-700 text-center">Costing</span>
                            </div>
                        </div>

                        <!-- Other -->
                        <div class="doc-type-option" data-type="OTHER" onclick="selectDocType('OTHER', this)">
                            <div class="flex flex-col items-center justify-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer transition-all hover:border-gray-400 hover:bg-gray-50">
                                <div class="w-12 h-12 bg-gray-100 rounded-lg flex items-center justify-center mb-2">
                                    <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                                    </svg>
                                </div>
                                <span class="text-xs font-medium text-gray-700 text-center">Other</span>
                            </div>
                        </div>
                    </div>
                    <input type="hidden" id="docType" name="document_type" required>
                    <p id="docTypeError" class="mt-2 text-sm text-red-600 hidden">Please select a document type</p>
                </div>

                <!-- Enhanced Project Stage Selection -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-3">Project Stage *</label>
                    <div class="grid grid-cols-2 sm:grid-cols-4 gap-3">
                        <!-- Initiation -->
                        <div class="stage-option" data-stage="INIT" onclick="selectStage('INIT', this)">
                            <div class="flex flex-col items-center justify-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer transition-all hover:border-blue-400 hover:bg-blue-50">
                                <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center mb-2">
                                    <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                                    </svg>
                                </div>
                                <span class="text-xs font-semibold text-gray-700 text-center">Initiation</span>
                            </div>
                        </div>

                        <!-- Planning -->
                        <div class="stage-option" data-stage="PLAN" onclick="selectStage('PLAN', this)">
                            <div class="flex flex-col items-center justify-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer transition-all hover:border-yellow-400 hover:bg-yellow-50">
                                <div class="w-12 h-12 bg-yellow-100 rounded-full flex items-center justify-center mb-2">
                                    <svg class="w-6 h-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path>
                                    </svg>
                                </div>
                                <span class="text-xs font-semibold text-gray-700 text-center">Planning</span>
                            </div>
                        </div>

                        <!-- Execution -->
                        <div class="stage-option" data-stage="EXEC" onclick="selectStage('EXEC', this)">
                            <div class="flex flex-col items-center justify-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer transition-all hover:border-green-400 hover:bg-green-50">
                                <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center mb-2">
                                    <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path>
                                    </svg>
                                </div>
                                <span class="text-xs font-semibold text-gray-700 text-center">Execution</span>
                            </div>
                        </div>

                        <!-- Closeout -->
                        <div class="stage-option" data-stage="CLOSE" onclick="selectStage('CLOSE', this)">
                            <div class="flex flex-col items-center justify-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer transition-all hover:border-purple-400 hover:bg-purple-50">
                                <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center mb-2">
                                    <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                </div>
                                <span class="text-xs font-semibold text-gray-700 text-center">Closeout</span>
                            </div>
                        </div>
                    </div>
                    <input type="hidden" id="docStage" name="project_stage" required>
                    <p id="docStageError" class="mt-2 text-sm text-red-600 hidden">Please select a project stage</p>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Version</label>
                        <input
                            type="text"
                            id="docVersion"
                            value="1.0"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                            placeholder="e.g., 1.0, 2.1"
                        >
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Tags (comma-separated)</label>
                        <input
                            type="text"
                            id="docTags"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                            placeholder="e.g., contract, legal, important"
                        >
                    </div>
                </div>
            </div>

            <div class="mt-6 flex gap-3">
                <button type="submit" class="flex-1 bg-blue-600 text-white py-2.5 rounded-lg hover:bg-blue-700 transition font-semibold">
                    Upload Document
                </button>
                <button type="button" onclick="closeUploadModal()" class="px-6 py-2.5 border border-gray-300 rounded-lg hover:bg-gray-50 transition">
                    Cancel
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Downpayment Warning Modal -->
<div id="downpaymentWarningModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 overflow-y-auto h-full w-full z-50 hidden">
    <div class="relative top-20 mx-auto p-0 border w-full max-w-md shadow-2xl rounded-xl bg-white">
        <!-- Modal Header -->
        <div class="flex items-center justify-between p-6 border-b border-gray-200 bg-gradient-to-r from-red-50 to-orange-50 rounded-t-xl">
            <div class="flex items-center">
                <div class="flex-shrink-0 bg-red-100 rounded-full p-3">
                    <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                </div>
                <div class="ml-4">
                    <h3 class="text-lg font-bold text-gray-900">Payment Required</h3>
                    <p class="text-sm text-gray-600">Downpayment Pending</p>
                </div>
            </div>
            <button onclick="closeDownpaymentModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>

        <!-- Modal Body -->
        <div class="p-6">
            <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-4">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <svg class="h-5 w-5 text-yellow-400" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                        </svg>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm text-yellow-700">
                            <strong>Important Notice:</strong> The client has not paid the downpayment for this project yet.
                        </p>
                    </div>
                </div>
            </div>

            <div class="space-y-3">
                <div class="flex items-start">
                    <svg class="w-5 h-5 text-gray-400 mt-0.5 mr-3" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V7z" clip-rule="evenodd"/>
                    </svg>
                    <div>
                        <p class="text-sm font-medium text-gray-900">Project Details</p>
                        <p class="text-sm text-gray-600 mt-1">
                            <strong>Project:</strong> {{ project.project_name }}<br>
                            <strong>Client:</strong> {{ project.client.company_name|default:"N/A" }}
                        </p>
                    </div>
                </div>

                <div class="flex items-start">
                    <svg class="w-5 h-5 text-gray-400 mt-0.5 mr-3" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"/>
                    </svg>
                    <div>
                        <p class="text-sm font-medium text-gray-900">Action Required</p>
                        <p class="text-sm text-gray-600 mt-1">
                            Please follow up with the client to secure the downpayment before proceeding with project activities.
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal Footer -->
        <div class="flex items-center justify-between p-6 border-t border-gray-200 bg-gray-50 rounded-b-xl">
            <label class="flex items-center cursor-pointer">
                <input type="checkbox" id="dontShowAgain" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                <span class="ml-2 text-sm text-gray-600">Don't show again for this project</span>
            </label>
            <button onclick="closeDownpaymentModal()"
                    class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium rounded-lg transition-colors">
                Got it
            </button>
        </div>
    </div>
</div>

<!-- Downpayment Update Modal -->
<div id="downpaymentUpdateModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 overflow-y-auto h-full w-full z-50 hidden">
    <div class="relative top-10 mx-auto p-0 border w-full max-w-lg shadow-2xl rounded-xl bg-white">
        <!-- Modal Header -->
        <div class="flex items-center justify-between p-6 border-b border-gray-200 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-t-xl">
            <div class="flex items-center">
                <div class="flex-shrink-0 bg-blue-100 rounded-full p-3">
                    <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                </div>
                <div class="ml-4">
                    <h3 class="text-lg font-bold text-gray-900">Update Downpayment</h3>
                    <p class="text-sm text-gray-600">Mark payment status and upload evidence</p>
                </div>
            </div>
            <button onclick="closeDownpaymentUpdateModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>

        <!-- Modal Body -->
        <form id="downpaymentForm" method="post" action="{% url 'update_downpayment' project.id %}" enctype="multipart/form-data" class="p-6">
            {% csrf_token %}

            <!-- Payment Status -->
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-3">Payment Status</label>
                <div class="flex gap-4">
                    <label class="flex-1 relative">
                        <input type="radio" name="downpayment_paid" value="true"
                               {% if project.downpayment_paid %}checked{% endif %}
                               class="peer sr-only">
                        <div class="flex items-center justify-center p-4 border-2 rounded-lg cursor-pointer transition-all peer-checked:border-green-500 peer-checked:bg-green-50 hover:border-green-300">
                            <svg class="w-5 h-5 mr-2 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                            </svg>
                            <span class="font-medium">Paid</span>
                        </div>
                    </label>
                    <label class="flex-1 relative">
                        <input type="radio" name="downpayment_paid" value="false"
                               {% if not project.downpayment_paid %}checked{% endif %}
                               class="peer sr-only">
                        <div class="flex items-center justify-center p-4 border-2 rounded-lg cursor-pointer transition-all peer-checked:border-red-500 peer-checked:bg-red-50 hover:border-red-300">
                            <svg class="w-5 h-5 mr-2 text-red-600" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                            </svg>
                            <span class="font-medium">Not Paid</span>
                        </div>
                    </label>
                </div>
            </div>

            <!-- Evidence Upload -->
            <div class="mb-6">
                <label for="evidenceFile" class="block text-sm font-medium text-gray-700 mb-2">
                    Payment Evidence
                    <span class="text-gray-500 font-normal">(Optional)</span>
                </label>
                <div class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-lg hover:border-blue-400 transition-colors">
                    <div class="space-y-1 text-center">
                        <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                            <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        <div class="flex text-sm text-gray-600">
                            <label for="evidenceFile" class="relative cursor-pointer bg-white rounded-md font-medium text-blue-600 hover:text-blue-500">
                                <span>Upload a file</span>
                                <input id="evidenceFile" name="downpayment_evidence" type="file" class="sr-only" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx" onchange="displayEvidenceFileName(this)">
                            </label>
                            <p class="pl-1">or drag and drop</p>
                        </div>
                        <p class="text-xs text-gray-500">PDF, PNG, JPG, DOC up to 10MB</p>
                        {% if project.downpayment_evidence %}
                            <p class="text-xs text-green-600 mt-2">
                                Current: <a href="{{ project.downpayment_evidence.url }}" target="_blank" class="underline">View existing file</a>
                            </p>
                        {% endif %}
                        <p id="selectedFileName" class="text-xs text-blue-600 mt-2 hidden"></p>
                    </div>
                </div>
            </div>

            <!-- Notes -->
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                <div class="flex">
                    <svg class="w-5 h-5 text-blue-400 mr-3 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                    </svg>
                    <div class="text-sm text-blue-700">
                        <p class="font-medium mb-1">Upload Evidence:</p>
                        <ul class="list-disc list-inside space-y-1 text-xs">
                            <li>Bank transfer receipt</li>
                            <li>Check copy</li>
                            <li>Official receipt</li>
                            <li>Any proof of payment</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Modal Footer -->
            <div class="flex items-center justify-end gap-3 pt-4 border-t border-gray-200">
                <button type="button" onclick="closeDownpaymentUpdateModal()"
                        class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
                    Cancel
                </button>
                <button type="submit"
                        class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium rounded-lg transition-colors">
                    <svg class="w-4 h-4 inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                    </svg>
                    Save Changes
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Downpayment Evidence Preview Modal -->
<div id="evidencePreviewModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-4 mx-auto p-0 border w-11/12 max-w-5xl shadow-lg rounded-lg bg-white my-8">
        <!-- Modal Header -->
        <div class="flex items-center justify-between p-4 border-b border-gray-200 bg-gray-50 rounded-t-lg">
            <div class="flex items-center space-x-3">
                <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                </svg>
                <div>
                    <h3 class="text-lg font-semibold text-gray-900">Downpayment Evidence</h3>
                    <p id="evidenceFileName" class="text-xs text-gray-500 mt-0.5"></p>
                </div>
            </div>
            <button onclick="closeEvidencePreview()" class="text-gray-400 hover:text-gray-600 transition-colors">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>

        <!-- Modal Body -->
        <div class="p-0">
            <!-- Loading State -->
            <div id="evidencePreviewLoading" class="hidden flex items-center justify-center h-96">
                <div class="text-center">
                    <svg class="animate-spin h-12 w-12 text-blue-600 mx-auto mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <p class="text-gray-600 text-sm">Loading preview...</p>
                </div>
            </div>

            <!-- Error State -->
            <div id="evidencePreviewError" class="hidden flex items-center justify-center h-96">
                <div class="text-center max-w-md mx-auto p-6">
                    <svg class="w-16 h-16 text-red-500 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <p class="text-gray-700 mb-2 font-medium">Unable to preview this file</p>
                    <p class="text-gray-500 text-sm mb-4">This file type cannot be previewed in the browser. Please download the file to view it.</p>
                </div>
            </div>

            <!-- Preview Content -->
            <div id="evidencePreviewContent" class="hidden bg-gray-100 flex items-center justify-center" style="min-height: 70vh;">
                <!-- Image Preview -->
                <img id="evidencePreviewImage" class="hidden max-w-full max-h-[70vh] object-contain" alt="Evidence" />
                <!-- PDF Preview -->
                <iframe id="evidencePreviewIframe" class="hidden w-full" style="height: 70vh; border: none;"></iframe>
            </div>
        </div>

        <!-- Modal Footer -->
        <div class="flex items-center justify-end gap-3 p-4 border-t border-gray-200 bg-gray-50 rounded-b-lg">
            <button onclick="closeEvidencePreview()" class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
                Close
            </button>
            <a id="evidenceDownloadBtn" href="#" download class="inline-flex items-center px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition-colors">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                </svg>
                Download
            </a>
        </div>
    </div>
</div>

<!-- Add Subcontractor Modal -->
<div id="subcontractorModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-10 mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-md bg-white">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold text-gray-900">Add Subcontractor</h3>
            <button onclick="closeSubcontractorModal()" class="text-gray-400 hover:text-gray-600">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>

        <form id="subcontractorForm" onsubmit="submitSubcontractorForm(event)">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Subcontractor Name -->
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Subcontractor Name *</label>
                    <input type="text" id="subcontractorNameInput" name="subcontractor_name" required class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Enter subcontractor name">
                </div>

                <!-- Contact Person -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Contact Person *</label>
                    <input type="text" id="contactPersonInput" name="contact_person" required class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Contact person name">
                </div>

                <!-- Contact Number -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Contact Number *</label>
                    <input type="tel" id="contactNumberInput" name="contact_number" required class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="+63 XXX XXX XXXX">
                </div>

                <!-- Contract Number -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Contract Number *</label>
                    <input type="text" id="contractNumberInput" name="contract_number" required class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="CTR-XXXX">
                </div>

                <!-- Contract Amount -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Contract Amount *</label>
                    <input type="number" id="contractAmountInput" name="contract_amount" step="0.01" min="0" required class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="0.00">
                </div>

                <!-- Status -->
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Status *</label>
                    <select id="statusInput" name="status" required class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="PEND">Pending</option>
                        <option value="PROG" selected>In Progress</option>
                        <option value="COMP">Completed</option>
                        <option value="CANC">Cancelled</option>
                    </select>
                </div>

                <!-- Scope of Work -->
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Scope of Work *</label>
                    <textarea id="scopeOfWorkInput" name="scope_of_work" rows="3" required class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Describe the scope of work..."></textarea>
                </div>
            </div>

            <div class="flex justify-end gap-3 mt-6">
                <button type="button" onclick="closeSubcontractorModal()" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition">
                    Cancel
                </button>
                <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                    Add Subcontractor
                </button>
            </div>
        </form>
    </div>
</div>

<script>
const PROJECT_ID = Number('{{ project.id|default:"0" }}');
const USER_ROLE = '{{ role|escapejs }}';

// Upload modal variables
let selectedFiles = [];

// Load subcontractors on page load
document.addEventListener('DOMContentLoaded', function() {
    if (USER_ROLE === "OM" || USER_ROLE === "EG") {
        loadProjectSubcontractors();
    }
    
    // Calculate cost per square meter
    calculateCostPerSqm();
    
    // Update floor area from BOQ data
    updateFloorAreaFromBOQData();
    
    // Format large numbers to prevent overlapping
    formatLargeNumbers();
    
    // Initialize BOQ pagination
    initializeBOQPagination();
});

function calculateCostPerSqm() {
    const costPerSqmElement = document.getElementById('costPerSqm');
    if (costPerSqmElement) {
        const lotSize = parseFloat('{{ project.lot_size|default:0 }}');
        const floorArea = parseFloat('{{ project.floor_area|default:0 }}');
        const totalCost = parseFloat('{{ project.extracted_total_cost|default:0 }}');
        
        // Use floor area if available, otherwise use lot size
        const area = floorArea > 0 ? floorArea : lotSize;
        
        if (area > 0 && totalCost > 0) {
            const costPerSqm = totalCost / area;
            costPerSqmElement.textContent = 'â‚±' + costPerSqm.toLocaleString('en-PH', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }
    }
}

// Update floor area display from BOQ data
function updateFloorAreaFromBOQData() {
    const boqDataScript = document.getElementById('boq-data');
    if (boqDataScript) {
        try {
            let rawData = boqDataScript.textContent;
            rawData = rawData
                .replace(/'/g, '"')
                .replace(/True/g, 'true')
                .replace(/False/g, 'false')
                .replace(/None/g, 'null');
            
            const boqData = JSON.parse(rawData);
            const floorArea = boqData.floor_area || boqData.boq_project_info?.floor_area || 0;
            
            // Update floor area display if we have data
            if (floorArea > 0) {
                const floorAreaElement = document.getElementById('floorAreaDisplay');
                if (floorAreaElement) {
                    floorAreaElement.textContent = Math.round(floorArea) + ' mÂ²';
                }
            }
        } catch (e) {
            console.error('Error updating floor area from BOQ data:', e);
        }
    }
}

// Format large numbers to prevent overlapping
function formatLargeNumbers() {
    // Format total cost display
    const totalCostElement = document.getElementById('totalCostDisplay');
    if (totalCostElement) {
        const currentText = totalCostElement.textContent;
        const amount = parseFloat(currentText.replace('â‚±', '').replace(/,/g, ''));
        if (!isNaN(amount)) {
            const formattedAmount = 'â‚±' + amount.toLocaleString('en-PH', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
            totalCostElement.textContent = formattedAmount;
            
            // Add long-number class if the text is very long (more than 15 characters)
            if (formattedAmount.length > 15) {
                totalCostElement.classList.add('long-number');
            }
        }
    }
    
    // Check all BOQ summary values for long numbers
    document.querySelectorAll('.boq-summary-value').forEach(element => {
        const text = element.textContent;
        if (text.length > 15) {
            element.classList.add('long-number');
        }
    });
}

function loadProjectSubcontractors() {
    fetch('/projects/api/subcontractors/')
        .then(response => response.json())
        .then(data => {
            const projectSubcontractors = (data.subcontractors || []).filter(s => s.project_id == PROJECT_ID);
            displaySubcontractors(projectSubcontractors);
        })
        .catch(error => {
            console.error('Error loading subcontractors:', error);
            document.getElementById('subcontractorsList').innerHTML = `
                <div class="text-center py-6 text-red-500">
                    <p class="text-sm">Error loading subcontractors</p>
                </div>
            `;
        });
}

function displaySubcontractors(subcontractors) {
    const container = document.getElementById('subcontractorsList');
    const countEl = document.getElementById('subcontractorCount');

    countEl.textContent = `${subcontractors.length} subcontractor${subcontractors.length !== 1 ? 's' : ''}`;

    if (subcontractors.length === 0) {
        container.innerHTML = `
            <div class="text-center py-6 text-gray-500">
                <svg class="w-10 h-10 text-gray-400 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
                </svg>
                <p class="text-sm mb-2">No subcontractors added yet</p>
                <button onclick="openAddSubcontractorModal()" class="text-blue-600 hover:text-blue-700 font-medium text-sm">
                    Add your first subcontractor
                </button>
            </div>
        `;
        return;
    }

    container.innerHTML = subcontractors.map(sub => {
        const balance = parseFloat(sub.contract_amount) - parseFloat(sub.amount_paid);
        const statusColor = {
            'PEND': 'bg-yellow-100 text-yellow-800',
            'PROG': 'bg-blue-100 text-blue-800',
            'COMP': 'bg-green-100 text-green-800',
            'CANC': 'bg-red-100 text-red-800'
        }[sub.status] || 'bg-gray-100 text-gray-800';

        return `
            <div class="border border-gray-200 rounded-lg p-4 hover:bg-gray-50 transition">
                <div class="flex justify-between items-start">
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-2">
                            <h4 class="font-semibold text-gray-900">${sub.subcontractor_name}</h4>
                            <span class="px-2 py-0.5 text-xs font-medium rounded-full ${statusColor}">
                                ${sub.status_display}
                            </span>
                        </div>
                        <div class="grid grid-cols-2 gap-2 text-sm">
                            <div>
                                <span class="text-gray-500">Contact:</span>
                                <span class="text-gray-900 font-medium">${sub.contact_person}</span>
                            </div>
                            <div>
                                <span class="text-gray-500">Phone:</span>
                                <span class="text-gray-900">${sub.contact_number}</span>
                            </div>
                            <div>
                                <span class="text-gray-500">Contract:</span>
                                <span class="text-gray-900">${sub.contract_number}</span>
                            </div>
                            <div>
                                <span class="text-gray-500">Amount:</span>
                                <span class="text-gray-900 font-semibold">${formatCurrency(sub.contract_amount)}</span>
                            </div>
                        </div>
                        <div class="mt-2 flex items-center gap-4 text-xs">
                            <div>
                                <span class="text-gray-500">Paid:</span>
                                <span class="text-green-600 font-medium">${formatCurrency(sub.amount_paid)}</span>
                            </div>
                            <div>
                                <span class="text-gray-500">Balance:</span>
                                <span class="${balance > 0 ? 'text-orange-600' : 'text-gray-600'} font-medium">${formatCurrency(balance)}</span>
                            </div>
                        </div>
                    </div>
                    <a href="/projects/subcontractors/" class="ml-4 text-blue-600 hover:text-blue-700 text-sm font-medium">
                        View Details â†’
                    </a>
                </div>
            </div>
        `;
    }).join('');
}

function openAddSubcontractorModal() {
    document.getElementById('subcontractorForm').reset();
    document.getElementById('subcontractorModal').classList.remove('hidden');
}

function closeSubcontractorModal() {
    document.getElementById('subcontractorModal').classList.add('hidden');
}

function submitSubcontractorForm(event) {
    event.preventDefault();

    const formData = new FormData(event.target);
    const data = {
        project_id: PROJECT_ID,
        subcontractor_name: formData.get('subcontractor_name'),
        contact_person: formData.get('contact_person'),
        contact_number: formData.get('contact_number'),
        contract_number: formData.get('contract_number'),
        contract_amount: formData.get('contract_amount'),
        status: formData.get('status'),
        scope_of_work: formData.get('scope_of_work'),
        amount_paid: 0
    };

    fetch('/projects/api/subcontractors/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            closeSubcontractorModal();
            loadProjectSubcontractors();
            showNotification('Subcontractor added successfully', 'success');
        } else {
            showNotification(data.error || 'An error occurred', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('An error occurred. Please try again.', 'error');
    });
}

function formatCurrency(amount) {
    return 'â‚±' + parseFloat(amount).toLocaleString('en-PH', {minimumFractionDigits: 2, maximumFractionDigits: 2});
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function showNotification(message, type = 'success') {
    // Create toast container if it doesn't exist
    let container = document.getElementById('toastContainer');
    if (!container) {
        container = document.createElement('div');
        container.id = 'toastContainer';
        container.className = 'fixed top-4 right-4 z-50 space-y-2';
        document.body.appendChild(container);
    }

    // Create toast element
    const toast = document.createElement('div');
    const bgColor = type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500';
    const icon = type === 'success'
        ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />'
        : '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />';

    toast.className = `${bgColor} text-white px-6 py-4 rounded-lg shadow-lg flex items-center gap-3 min-w-80 transform transition-all duration-300 translate-x-full opacity-0`;
    toast.innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            ${icon}
        </svg>
        <span class="flex-1">${message}</span>
        <button onclick="this.parentElement.remove()" class="text-white hover:text-gray-200 transition">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
        </button>
    `;

    container.appendChild(toast);

    // Animate in
    setTimeout(() => {
        toast.classList.remove('translate-x-full', 'opacity-0');
    }, 10);

    // Auto-remove after 5 seconds
    setTimeout(() => {
        toast.classList.add('translate-x-full', 'opacity-0');
        setTimeout(() => toast.remove(), 300);
    }, 5000);
}

// Close modal when clicking outside
document.getElementById('subcontractorModal')?.addEventListener('click', function(event) {
    if (event.target === this) closeSubcontractorModal();
});


// BOQ Functions
function toggleBOQPreview() {
    const preview = document.getElementById('boqPreview');
    if (preview) {
        preview.classList.toggle('hidden');
        if (!preview.classList.contains('hidden')) {
            // Initialize pagination when showing
            initializeBOQPagination();
        }
    }
}

// BOQ Pagination Variables
let currentPage = 1;
let itemsPerPage = 10;
let allBOQItems = [];

function initializeBOQPagination() {
    // Get BOQ data from JSON script tag
    const boqDataScript = document.getElementById('boq-data');
    let rawBoqItems = [];
    
    if (boqDataScript) {
        try {
            // Get the raw text content
            let rawData = boqDataScript.textContent;
            console.log('DEBUG: Raw BOQ Data:', rawData);
            
            // Clean up Python-style data to proper JSON
            rawData = rawData
                .replace(/'/g, '"')  // Replace single quotes with double quotes
                .replace(/True/g, 'true')  // Replace Python True with JavaScript true
                .replace(/False/g, 'false')  // Replace Python False with JavaScript false
                .replace(/None/g, 'null');  // Replace Python None with JavaScript null
            
            console.log('DEBUG: Cleaned BOQ Data:', rawData);
            
            const boqData = JSON.parse(rawData);
            rawBoqItems = boqData.boq_items || [];
        } catch (e) {
            console.error('DEBUG: Error parsing BOQ data:', e);
            console.error('DEBUG: Raw data was:', boqDataScript.textContent);
            rawBoqItems = [];
        }
    }
    
    allBOQItems = rawBoqItems;
    
    console.log('DEBUG: Processed BOQ items:', allBOQItems);
    console.log('DEBUG: BOQ items length:', allBOQItems.length);
    
    if (allBOQItems.length > 0) {
        renderHierarchicalBOQItems();
        
        // Add event listeners
        document.getElementById('prevPage')?.addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                renderHierarchicalBOQItems();
            }
        });
        
        document.getElementById('nextPage')?.addEventListener('click', () => {
            const totalPages = Math.ceil(allBOQItems.length / itemsPerPage);
            if (currentPage < totalPages) {
                currentPage++;
                renderHierarchicalBOQItems();
            }
        });
        
        document.getElementById('itemsPerPage')?.addEventListener('change', (e) => {
            itemsPerPage = parseInt(e.target.value);
            currentPage = 1; // Reset to first page
            renderHierarchicalBOQItems();
        });
    }
}

function renderHierarchicalBOQItems() {
    const displayContainer = document.getElementById('boqHierarchicalDisplay');
    if (!displayContainer) return;
    
    const totalItems = allBOQItems.length;
    const totalPages = Math.ceil(totalItems / itemsPerPage);
    const startIndex = (currentPage - 1) * itemsPerPage;
    const endIndex = Math.min(startIndex + itemsPerPage, totalItems);
    
    // Get items for current page
    const pageItems = allBOQItems.slice(startIndex, endIndex);
    
    // Group items by division and task
    const groupedData = groupBOQItemsByDivisionAndTask(pageItems);
    
    // Render hierarchical display
    let html = '';
    Object.entries(groupedData).forEach(([division, divisionData]) => {
        html += `
            <div class="border border-gray-200 rounded-lg overflow-hidden mb-6">
                <!-- Division Header -->
                <div class="bg-gray-800 text-white px-4 py-3">
                    <h3 class="text-lg font-semibold">${division}</h3>
                    <p class="text-sm text-gray-300">Subtotal: â‚±${formatCurrency(divisionData.subtotal)}</p>
                </div>
                
                <div class="bg-white">
        `;
        
        // Group by task within division
        Object.entries(divisionData.tasks).forEach(([task, taskData]) => {
            html += `
                <!-- Task Header -->
                <div class="bg-gray-100 px-4 py-2 border-b border-gray-200">
                    <h4 class="text-md font-medium text-gray-800">${task} (Subtotal: â‚±${formatCurrency(taskData.subtotal)})</h4>
                </div>
                
                <!-- Items Table -->
                <div class="overflow-x-auto">
                    <table class="min-w-full text-sm">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wide">Code</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wide">Description</th>
                                <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wide">UOM</th>
                                <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wide">Qty</th>
                                <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wide">Unit Cost</th>
                                <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wide">Amount</th>
                                <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wide">Type</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
            `;
            
            taskData.items.forEach(item => {
                // Handle both string and boolean values for is_requirement
                const isRequirement = item.is_requirement === true || item.is_requirement === 'true' || item.is_requirement === 'True';
                const typeText = isRequirement ? 'Requirement' : 'Material';
                const typeColor = isRequirement ? 'bg-orange-100 text-orange-800' : 'bg-blue-100 text-blue-800';
                
                html += `
                    <tr class="hover:bg-gray-50">
                        <td class="px-3 py-2 text-sm font-medium text-gray-900">${item.code || ''}</td>
                        <td class="px-3 py-2 text-sm text-gray-900">${item.description || ''}</td>
                        <td class="px-3 py-2 text-sm text-gray-900 text-center">${item.uom || ''}</td>
                        <td class="px-3 py-2 text-sm text-gray-900 text-right">${formatNumber(item.quantity || 0)}</td>
                        <td class="px-3 py-2 text-sm text-gray-900 text-right">â‚±${formatCurrency(item.unit_cost || 0)}</td>
                        <td class="px-3 py-2 text-sm font-semibold text-gray-900 text-right">â‚±${formatCurrency(item.amount || 0)}</td>
                        <td class="px-3 py-2 text-center">
                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium ${typeColor}">
                                ${typeText}
                            </span>
                        </td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
        });
        
        html += `
                </div>
            </div>
        `;
    });
    
    displayContainer.innerHTML = html;
    
    // Update pagination info
    const showingStart = document.getElementById('showingStart');
    const showingEnd = document.getElementById('showingEnd');
    const totalItemsEl = document.getElementById('totalItems');
    
    if (showingStart) showingStart.textContent = startIndex + 1;
    if (showingEnd) showingEnd.textContent = endIndex;
    if (totalItemsEl) totalItemsEl.textContent = totalItems;
    
    // Update pagination buttons
    const prevBtn = document.getElementById('prevPage');
    const nextBtn = document.getElementById('nextPage');
    
    if (prevBtn) prevBtn.disabled = currentPage === 1;
    if (nextBtn) nextBtn.disabled = currentPage === totalPages;
    
    // Update page numbers
    const pageNumbers = document.getElementById('pageNumbers');
    if (pageNumbers) {
        pageNumbers.innerHTML = '';
        
        const maxVisiblePages = 5;
        let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
        let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
        
        if (endPage - startPage + 1 < maxVisiblePages) {
            startPage = Math.max(1, endPage - maxVisiblePages + 1);
        }
        
        for (let i = startPage; i <= endPage; i++) {
            const pageBtn = document.createElement('button');
            pageBtn.className = `px-2 py-1 text-xs border rounded ${
                i === currentPage 
                    ? 'bg-blue-500 text-white border-blue-500' 
                    : 'border-gray-300 hover:bg-gray-50'
            }`;
            pageBtn.textContent = i;
            pageBtn.addEventListener('click', () => {
                currentPage = i;
                renderHierarchicalBOQItems();
            });
            pageNumbers.appendChild(pageBtn);
        }
    }
}

function groupBOQItemsByDivisionAndTask(items) {
    const grouped = {};
    
    items.forEach(item => {
        const division = item.division || 'General Items';
        const task = item.task || 'General Items';
        
        if (!grouped[division]) {
            grouped[division] = {
                subtotal: 0,
                tasks: {}
            };
        }
        
        if (!grouped[division].tasks[task]) {
            grouped[division].tasks[task] = {
                subtotal: 0,
                items: []
            };
        }
        
        const amount = parseFloat(item.amount) || 0;
        grouped[division].subtotal += amount;
        grouped[division].tasks[task].subtotal += amount;
        grouped[division].tasks[task].items.push(item);
    });
    
    return grouped;
}

function formatCurrency(amount) {
    if (amount === null || amount === undefined || amount === '') return '0.00';
    const number = parseFloat(amount);
    if (isNaN(number)) return '0.00';
    return number.toLocaleString('en-PH', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    });
}

function formatNumber(amount) {
    if (amount === null || amount === undefined || amount === '') return '0';
    const number = parseFloat(amount);
    if (isNaN(number)) return '0';
    return number.toLocaleString('en-PH', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    });
}

function exportBOQToExcel() {
    const projectId = PROJECT_ID;
    
    // Show loading state
    const button = event.target.closest('button');
    const originalText = button.innerHTML;
    button.innerHTML = `
        <svg class="w-4 h-4 mr-1 animate-spin" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd"></path>
        </svg>
        Exporting...
    `;
    button.disabled = true;
    
    // Use fetch to download the file
    const downloadUrl = `/projects/api/boq-export/${projectId}/`;
    
    fetch(downloadUrl, {
        method: 'GET',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.blob();
    })
    .then(blob => {
        // Create a blob URL and trigger download
        const url = window.URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `BOQ_Project_${projectId}_${new Date().toISOString().split('T')[0]}.xlsx`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        window.URL.revokeObjectURL(url);
        
        // Reset button and show success message
        button.innerHTML = originalText;
        button.disabled = false;
        showNotification('BOQ exported successfully!', 'success');
    })
    .catch(error => {
        console.error('Export error:', error);
        // Reset button and show error message
        button.innerHTML = originalText;
        button.disabled = false;
        showNotification('Error exporting BOQ. Please try again.', 'error');
    });
}

// Upload Modal Functions
function openUploadModal() {
    document.getElementById('uploadModal').style.display = 'flex';
    document.body.style.overflow = 'hidden';

    // Reset selections
    document.querySelectorAll('.doc-type-option > div, .stage-option > div').forEach(option => {
        option.classList.remove('border-blue-600', 'bg-blue-50', 'border-green-600', 'bg-green-50',
                                'border-purple-600', 'bg-purple-50', 'border-orange-600', 'bg-orange-50',
                                'border-indigo-600', 'bg-indigo-50', 'border-cyan-600', 'bg-cyan-50',
                                'border-yellow-600', 'bg-yellow-50', 'border-gray-600', 'bg-gray-50');
        option.classList.add('border-gray-200');
    });
    document.getElementById('docType').value = '';
    document.getElementById('docStage').value = '';
}

function closeUploadModal() {
    document.getElementById('uploadModal').style.display = 'none';
    document.body.style.overflow = 'auto';
    document.getElementById('uploadForm').reset();
    clearFiles();
}

function handleFileSelect(event) {
    const files = Array.from(event.target.files);
    if (files.length > 0) {
        selectedFiles = files;
        displaySelectedFiles();
        document.getElementById('uploadZone').style.borderColor = '#3b82f6';
    }
}

function displaySelectedFiles() {
    const fileListContainer = document.getElementById('fileList');
    const fileCountElement = document.getElementById('fileCount');

    if (selectedFiles.length === 0) {
        document.getElementById('selectedFiles').classList.add('hidden');
        return;
    }

    document.getElementById('selectedFiles').classList.remove('hidden');
    fileCountElement.textContent = selectedFiles.length;

    fileListContainer.innerHTML = selectedFiles.map((file, index) => `
        <div class="flex items-center justify-between p-3 bg-blue-50 rounded-lg">
            <div class="flex items-center gap-3 flex-1 min-w-0">
                <svg class="w-6 h-6 text-blue-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                </svg>
                <div class="flex-1 min-w-0">
                    <p class="font-semibold text-gray-900 text-sm truncate">${file.name}</p>
                    <p class="text-xs text-gray-600">${formatFileSize(file.size)}</p>
                </div>
            </div>
            <button type="button" onclick="removeFile(${index})" class="text-red-600 hover:text-red-700 ml-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
    `).join('');
}

function removeFile(index) {
    selectedFiles.splice(index, 1);
    displaySelectedFiles();

    // Update the file input
    const dt = new DataTransfer();
    selectedFiles.forEach(file => dt.items.add(file));
    document.getElementById('fileInput').files = dt.files;

    if (selectedFiles.length === 0) {
        document.getElementById('uploadZone').style.borderColor = '#cbd5e1';
    }
}

function clearFiles() {
    selectedFiles = [];
    document.getElementById('fileInput').value = '';
    document.getElementById('selectedFiles').classList.add('hidden');
    document.getElementById('uploadZone').style.borderColor = '#cbd5e1';
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
}

// Document Type Selection
function selectDocType(type, element) {
    // Remove active state from all options
    document.querySelectorAll('.doc-type-option > div').forEach(option => {
        option.classList.remove('border-blue-600', 'bg-blue-50', 'border-green-600', 'bg-green-50',
                                'border-purple-600', 'bg-purple-50', 'border-orange-600', 'bg-orange-50',
                                'border-indigo-600', 'bg-indigo-50', 'border-cyan-600', 'bg-cyan-50',
                                'border-yellow-600', 'bg-yellow-50', 'border-gray-600', 'bg-gray-50');
        option.classList.add('border-gray-200');
    });

    // Add active state to selected option based on type
    const innerDiv = element.querySelector('div');
    innerDiv.classList.remove('border-gray-200');

    // Apply type-specific colors
    const colorMap = {
        'CONTRACT': ['border-blue-600', 'bg-blue-50'],
        'PERMIT': ['border-green-600', 'bg-green-50'],
        'PROGRESS': ['border-purple-600', 'bg-purple-50'],
        'INVOICE': ['border-orange-600', 'bg-orange-50'],
        'TECHNICAL': ['border-indigo-600', 'bg-indigo-50'],
        'PHOTO': ['border-cyan-600', 'bg-cyan-50'],
        'COSTING': ['border-yellow-600', 'bg-yellow-50'],
        'OTHER': ['border-gray-600', 'bg-gray-50']
    };

    if (colorMap[type]) {
        innerDiv.classList.add(...colorMap[type]);
    }

    // Set hidden input value
    document.getElementById('docType').value = type;
    document.getElementById('docTypeError').classList.add('hidden');
}

// Project Stage Selection
function selectStage(stage, element) {
    // Remove active state from all options
    document.querySelectorAll('.stage-option > div').forEach(option => {
        option.classList.remove('border-blue-600', 'bg-blue-50', 'border-yellow-600', 'bg-yellow-50',
                                'border-green-600', 'bg-green-50', 'border-purple-600', 'bg-purple-50');
        option.classList.add('border-gray-200');
    });

    // Add active state to selected option based on stage
    const innerDiv = element.querySelector('div');
    innerDiv.classList.remove('border-gray-200');

    // Apply stage-specific colors
    const colorMap = {
        'INIT': ['border-blue-600', 'bg-blue-50'],
        'PLAN': ['border-yellow-600', 'bg-yellow-50'],
        'EXEC': ['border-green-600', 'bg-green-50'],
        'CLOSE': ['border-purple-600', 'bg-purple-50']
    };

    if (colorMap[stage]) {
        innerDiv.classList.add(...colorMap[stage]);
    }

    // Set hidden input value
    document.getElementById('docStage').value = stage;
    document.getElementById('docStageError').classList.add('hidden');
}

// Handle upload
async function handleUpload(event) {
    event.preventDefault();

    // Validate file selection
    if (selectedFiles.length === 0) {
        showNotification('error', 'No Files Selected', 'Please select at least one file to upload');
        return;
    }

    // Validate document type selection
    const docType = document.getElementById('docType').value;
    if (!docType) {
        document.getElementById('docTypeError').classList.remove('hidden');
        showNotification('error', 'Document Type Required', 'Please select a document type');
        return;
    }

    // Validate project stage selection
    const docStage = document.getElementById('docStage').value;
    if (!docStage) {
        document.getElementById('docStageError').classList.remove('hidden');
        showNotification('error', 'Project Stage Required', 'Please select a project stage');
        return;
    }

    // Disable submit button to prevent double submission
    const submitBtn = event.target.querySelector('button[type="submit"]');
    const originalText = submitBtn.textContent;
    submitBtn.disabled = true;
    submitBtn.textContent = `Uploading ${selectedFiles.length} file(s)...`;

    const formData = new FormData();

    // Append all files
    selectedFiles.forEach(file => {
        formData.append('files', file);
    });

    formData.append('title', document.getElementById('docTitle').value);
    formData.append('description', document.getElementById('docDescription').value);
    formData.append('project', document.getElementById('docProject').value);
    formData.append('document_type', document.getElementById('docType').value);
    formData.append('project_stage', document.getElementById('docStage').value);
    formData.append('version', document.getElementById('docVersion').value);
    formData.append('tags', document.getElementById('docTags').value);

    try {
        const response = await fetch('/projects/api/document-upload/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: formData
        });

        const data = await response.json();

        if (response.ok) {
            const docTitle = document.getElementById('docTitle').value;
            const fileCount = selectedFiles.length;
            const message = fileCount === 1
                ? `Document "${docTitle}" has been uploaded successfully.`
                : `${fileCount} documents have been uploaded successfully.`;
            showNotification('success', 'Upload Successful!', message);
            closeUploadModal();
            // Reload the page to show the new documents
            window.location.reload();
        } else {
            showNotification('error', 'Upload Failed', data.error || 'An error occurred while uploading the document(s). Please try again.');
        }
    } catch (error) {
        console.error('Error uploading document:', error);
        showNotification('error', 'Upload Error', 'Network error occurred. Please check your connection and try again.');
    } finally {
        // Re-enable submit button
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
    }
}

// Notification System
function showNotification(type, title, message) {
    // Remove any existing notifications first
    document.querySelectorAll('.notification').forEach(n => n.remove());

    // Create notification element
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        max-width: 400px;
        min-width: 300px;
        padding: 16px 20px;
        border-radius: 8px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        display: flex;
        align-items: start;
        gap: 12px;
        z-index: 999999;
        background: ${type === 'success' ? '#10b981' : '#ef4444'};
        color: white;
        transform: translateX(500px);
        transition: transform 0.3s ease-out;
    `;

    const iconSVG = type === 'success'
        ? '<svg style="width: 24px; height: 24px; flex-shrink: 0;" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>'
        : '<svg style="width: 24px; height: 24px; flex-shrink: 0;" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>';

    notification.innerHTML = `
        ${iconSVG}
        <div style="flex: 1;">
            <div style="font-weight: 600; margin-bottom: 4px;">${title}</div>
            <div style="font-size: 14px; opacity: 0.9;">${message}</div>
        </div>
        <button onclick="this.parentElement.remove()" style="flex-shrink: 0; cursor: pointer; opacity: 0.8; background: none; border: none; color: white; padding: 0;">
            <svg style="width: 20px; height: 20px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
        </button>
    `;

    notification.className = 'notification';
    document.body.appendChild(notification);

    // Trigger slide-in animation
    setTimeout(() => {
        notification.style.transform = 'translateX(0)';
    }, 10);

    // Auto-dismiss after 5 seconds
    setTimeout(() => {
        notification.style.transform = 'translateX(500px)';
        setTimeout(() => notification.remove(), 300);
    }, 5000);
}

// Upload Schedule Modal Functions
function openUploadModal() {
    document.getElementById('uploadScheduleModal').classList.remove('hidden');
    document.body.style.overflow = 'hidden';
}

function closeUploadModal() {
    document.getElementById('uploadScheduleModal').classList.add('hidden');
    document.body.style.overflow = 'auto';
    // Reset form
    document.getElementById('uploadScheduleForm').reset();
    resetFileUpload();
}

function resetFileUpload() {
    const dropZoneContent = document.getElementById('drop-zone-content');
    const fileSelected = document.getElementById('file-selected');
    const uploadButton = document.getElementById('upload-button');

    if (dropZoneContent) dropZoneContent.classList.remove('hidden');
    if (fileSelected) fileSelected.classList.add('hidden');
    if (uploadButton) uploadButton.disabled = true;
}
</script>

<!-- Upload Schedule Modal -->
{% if role == 'PM' %}
<div id="uploadScheduleModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-11/12 max-w-2xl shadow-lg rounded-lg bg-white">
        <!-- Modal Header -->
        <div class="flex items-center justify-between pb-4 border-b border-gray-200">
            <div class="flex items-center space-x-3">
                <div class="w-12 h-12 bg-gradient-to-r from-blue-500 to-indigo-600 rounded-lg flex items-center justify-center">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                    </svg>
                </div>
                <div>
                    <h3 class="text-2xl font-bold text-gray-900">Upload Project Schedule</h3>
                    <p class="text-sm text-gray-600">{{ project.project_name }}</p>
                </div>
            </div>
            <button onclick="closeUploadModal()" class="text-gray-400 hover:text-gray-500">
                <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>

        <!-- Modal Body -->
        <div class="mt-4">
            <form id="uploadScheduleForm" method="post" action="{% url 'upload_project_schedule' project.id %}" enctype="multipart/form-data">
                {% csrf_token %}

                <!-- Upload Attempts Info -->
                <div class="mb-6 bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <div>
                                <p class="text-sm font-medium text-blue-900">Upload Attempts</p>
                                <p class="text-xs text-blue-700">You can upload up to 5 versions</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Instructions -->
                <div class="mb-6 bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                    <div class="flex items-start">
                        <svg class="w-5 h-5 text-yellow-600 mt-0.5 mr-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                        </svg>
                        <div class="flex-1">
                            <h4 class="text-sm font-semibold text-yellow-900 mb-2">Before Uploading</h4>
                            <ul class="text-sm text-yellow-800 space-y-1">
                                <li>â€¢ Generate and download the template first if you haven't already</li>
                                <li>â€¢ Fill in all required task information (Activity, Start Date, End Date)</li>
                                <li>â€¢ Ensure scope names match exactly with your project scopes</li>
                                <li>â€¢ Use the correct date format: DD-MMM-YY (e.g., 02-Aug-24)</li>
                                <li>â€¢ Maximum file size: 10MB</li>
                            </ul>
                            <a href="{% url 'generate_schedule_template' project.id %}" class="inline-flex items-center mt-2 text-sm font-medium text-yellow-700 hover:text-yellow-900">
                                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                Download Template
                            </a>
                        </div>
                    </div>
                </div>

                <!-- File Upload Area -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Schedule File *
                    </label>

                    <!-- Drag & Drop Zone -->
                    <div id="drop-zone" class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-blue-500 transition-colors cursor-pointer">
                        <div id="drop-zone-content">
                            <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                                <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                            </svg>
                            <div class="mt-4">
                                <label for="id_file" class="cursor-pointer">
                                    <span class="text-blue-600 hover:text-blue-700 font-medium">Click to upload</span>
                                    <span class="text-gray-600"> or drag and drop</span>
                                </label>
                                <p class="text-xs text-gray-500 mt-1">Excel files only (.xlsx, .xls) - Max 10MB</p>
                            </div>
                        </div>

                        <!-- File Selected -->
                        <div id="file-selected" class="hidden">
                            <div class="flex items-center justify-center space-x-3">
                                <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                <div class="text-left">
                                    <p id="file-name" class="text-sm font-medium text-gray-900"></p>
                                    <p id="file-size" class="text-xs text-gray-500"></p>
                                </div>
                                <button type="button" id="remove-file" class="ml-4 text-red-600 hover:text-red-800">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Hidden File Input -->
                    <input type="file" id="id_file" name="file" accept=".xlsx,.xls" class="hidden" required>
                </div>

                <!-- Modal Footer -->
                <div class="flex items-center justify-end space-x-3 pt-4 border-t border-gray-200">
                    <button type="button" onclick="closeUploadModal()" class="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
                        Cancel
                    </button>
                    <button type="submit" id="upload-button" disabled class="px-4 py-2 border border-transparent rounded-md text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed">
                        <span class="flex items-center">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                            </svg>
                            Upload Schedule
                        </span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Uploading Animation Overlay -->
<div id="uploadingOverlay" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 z-[60] flex items-center justify-center">
    <div class="bg-white rounded-lg p-8 max-w-sm w-full mx-4 text-center">
        <div class="mb-4">
            <!-- Spinning loader -->
            <svg class="animate-spin h-16 w-16 mx-auto text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
        </div>
        <h3 class="text-lg font-semibold text-gray-900 mb-2">Uploading Schedule...</h3>
        <p class="text-sm text-gray-600">Please wait while we process your file</p>
        <div class="mt-4">
            <div class="w-full bg-gray-200 rounded-full h-2">
                <div class="bg-blue-600 h-2 rounded-full animate-pulse" style="width: 100%"></div>
            </div>
        </div>
    </div>
</div>

<script>
// File Upload Modal Script
document.addEventListener('DOMContentLoaded', function() {
    const dropZone = document.getElementById('drop-zone');
    const fileInput = document.getElementById('id_file');
    const dropZoneContent = document.getElementById('drop-zone-content');
    const fileSelected = document.getElementById('file-selected');
    const fileName = document.getElementById('file-name');
    const fileSize = document.getElementById('file-size');
    const removeFileBtn = document.getElementById('remove-file');
    const uploadButton = document.getElementById('upload-button');
    const uploadForm = document.getElementById('uploadScheduleForm');
    const uploadingOverlay = document.getElementById('uploadingOverlay');

    // Show uploading animation on form submit
    if (uploadForm) {
        uploadForm.addEventListener('submit', function(e) {
            // Show uploading overlay
            uploadingOverlay.classList.remove('hidden');
            // Form will submit normally and redirect
        });
    }

    if (dropZone && fileInput) {
        // Click to upload
        dropZone.addEventListener('click', function(e) {
            if (e.target.id !== 'remove-file' && !e.target.closest('#remove-file')) {
                fileInput.click();
            }
        });

        // File input change
        fileInput.addEventListener('change', function(e) {
            if (this.files.length > 0) {
                displayFile(this.files[0]);
            }
        });

        // Drag and drop
        dropZone.addEventListener('dragover', function(e) {
            e.preventDefault();
            this.classList.add('border-blue-500', 'bg-blue-50');
        });

        dropZone.addEventListener('dragleave', function(e) {
            e.preventDefault();
            this.classList.remove('border-blue-500', 'bg-blue-50');
        });

        dropZone.addEventListener('drop', function(e) {
            e.preventDefault();
            this.classList.remove('border-blue-500', 'bg-blue-50');

            const files = e.dataTransfer.files;
            if (files.length > 0) {
                const file = files[0];
                // Check if it's an Excel file
                if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                    // Create a new FileList-like object
                    const dataTransfer = new DataTransfer();
                    dataTransfer.items.add(file);
                    fileInput.files = dataTransfer.files;
                    displayFile(file);
                } else {
                    alert('Please upload an Excel file (.xlsx or .xls)');
                }
            }
        });

        // Remove file
        if (removeFileBtn) {
            removeFileBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                fileInput.value = '';
                dropZoneContent.classList.remove('hidden');
                fileSelected.classList.add('hidden');
                uploadButton.disabled = true;
            });
        }

        function displayFile(file) {
            fileName.textContent = file.name;
            fileSize.textContent = formatFileSize(file.size);
            dropZoneContent.classList.add('hidden');
            fileSelected.classList.remove('hidden');
            uploadButton.disabled = false;
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }
    }
});
</script>
{% endif %}

<!-- Downpayment Modal Script -->
<script>
// Downpayment warning modal functions
function closeDownpaymentModal() {
    const modal = document.getElementById('downpaymentWarningModal');
    const dontShowAgain = document.getElementById('dontShowAgain');

    if (dontShowAgain && dontShowAgain.checked) {
        // Store preference in localStorage to not show again for this project
        const projectId = '{{ project.id }}';
        localStorage.setItem(`hideDownpaymentModal_${projectId}`, 'true');
    }

    if (modal) {
        modal.classList.add('hidden');
        document.body.style.overflow = 'auto';
    }
}

// Downpayment update modal functions
function openDownpaymentUpdateModal() {
    const modal = document.getElementById('downpaymentUpdateModal');
    if (modal) {
        modal.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    }
}

function closeDownpaymentUpdateModal() {
    const modal = document.getElementById('downpaymentUpdateModal');
    if (modal) {
        modal.classList.add('hidden');
        document.body.style.overflow = 'auto';
    }
}

function displayEvidenceFileName(input) {
    const fileNameDisplay = document.getElementById('selectedFileName');
    if (input.files && input.files[0]) {
        fileNameDisplay.textContent = 'Selected: ' + input.files[0].name;
        fileNameDisplay.classList.remove('hidden');
    } else {
        fileNameDisplay.classList.add('hidden');
    }
}

// Show downpayment modal on page load if not paid
document.addEventListener('DOMContentLoaded', function() {
    const downpaymentPaid = {{ project.downpayment_paid|lower }};
    const projectId = '{{ project.id }}';
    const hideModalPreference = localStorage.getItem(`hideDownpaymentModal_${projectId}`);

    // Only show if:
    // 1. Downpayment is not paid
    // 2. User hasn't chosen to hide it for this project
    if (!downpaymentPaid && hideModalPreference !== 'true') {
        const modal = document.getElementById('downpaymentWarningModal');
        if (modal) {
            // Small delay for better UX
            setTimeout(() => {
                modal.classList.remove('hidden');
                document.body.style.overflow = 'hidden';
            }, 500);
        }
    }
});

// Close modal when clicking outside
document.getElementById('downpaymentWarningModal')?.addEventListener('click', function(e) {
    if (e.target === this) {
        closeDownpaymentModal();
    }
});

// Evidence preview modal functions
function openEvidencePreview(fileUrl, fileName) {
    const modal = document.getElementById('evidencePreviewModal');
    const iframe = document.getElementById('evidencePreviewIframe');
    const imageEl = document.getElementById('evidencePreviewImage');
    const loading = document.getElementById('evidencePreviewLoading');
    const error = document.getElementById('evidencePreviewError');
    const content = document.getElementById('evidencePreviewContent');
    const fileNameDisplay = document.getElementById('evidenceFileName');
    const downloadBtn = document.getElementById('evidenceDownloadBtn');

    if (!modal || !iframe || !imageEl || !loading || !error || !content) return;

    // Show modal
    modal.classList.remove('hidden');
    document.body.style.overflow = 'hidden';

    // Set file name
    fileNameDisplay.textContent = fileName || 'Evidence file';

    // Set download button URL
    downloadBtn.href = fileUrl;

    // Reset states
    loading.classList.remove('hidden');
    error.classList.add('hidden');
    content.classList.add('hidden');
    iframe.classList.add('hidden');
    imageEl.classList.add('hidden');
    iframe.src = '';
    imageEl.src = '';

    // Get file extension
    const extension = fileName.toLowerCase().split('.').pop();

    // Check if file can be previewed
    const imageTypes = ['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp', 'svg'];
    const pdfTypes = ['pdf'];

    if (imageTypes.includes(extension)) {
        // For images, use direct img tag
        imageEl.onload = function() {
            loading.classList.add('hidden');
            content.classList.remove('hidden');
            imageEl.classList.remove('hidden');
        };

        imageEl.onerror = function() {
            loading.classList.add('hidden');
            error.classList.remove('hidden');
        };

        // Set image source
        imageEl.src = fileUrl;

    } else if (pdfTypes.includes(extension)) {
        // For PDFs, use iframe
        iframe.onload = function() {
            loading.classList.add('hidden');
            content.classList.remove('hidden');
            iframe.classList.remove('hidden');
        };

        iframe.onerror = function() {
            loading.classList.add('hidden');
            error.classList.remove('hidden');
        };

        // Set iframe source to PDF
        iframe.src = fileUrl + '#toolbar=1&navpanes=1&scrollbar=1';

    } else {
        // Cannot preview this file type
        loading.classList.add('hidden');
        error.classList.remove('hidden');
    }
}

function closeEvidencePreview() {
    const modal = document.getElementById('evidencePreviewModal');
    const iframe = document.getElementById('evidencePreviewIframe');
    const imageEl = document.getElementById('evidencePreviewImage');

    if (modal) {
        modal.classList.add('hidden');
        document.body.style.overflow = 'auto';
    }

    // Clear content
    if (iframe) {
        iframe.src = '';
        iframe.classList.add('hidden');
    }
    if (imageEl) {
        imageEl.src = '';
        imageEl.classList.add('hidden');
    }
}

// Close evidence preview modal when clicking outside
document.getElementById('evidencePreviewModal')?.addEventListener('click', function(e) {
    if (e.target === this) {
        closeEvidencePreview();
    }
});
</script>

{% endblock %}